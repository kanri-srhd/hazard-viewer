<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ (GeoJSON + Leaflet)</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ—ºï¸</text></svg>">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    header p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .region-selector {
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 8px;
      font-size: 13px;
    }
    
    .region-selector select {
      padding: 5px 8px;
      border-radius: 3px;
      border: 1px solid #ddd;
      font-size: 12px;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #map {
      flex: 1;
      background: #e0e0e0;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 15px;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar h2 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .status-list {
      list-style: none;
      margin-bottom: 15px;
    }

    .status-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #f9f9f9;
      border-left: 3px solid #667eea;
      font-size: 13px;
      color: #555;
      border-radius: 2px;
    }

    .status-item.loading {
      border-left-color: #ff9800;
      background: #fff8f0;
    }

    .status-item.success {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }

    .status-item.error {
      border-left-color: #f44336;
      background: #fef1f1;
    }

    .info-panel {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-size: 12px;
      margin-top: 10px;
    }

    .info-panel dt {
      font-weight: bold;
      color: #333;
      margin-top: 5px;
    }

    .info-panel dd {
      color: #666;
      margin-left: 10px;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .leaflet-popup-content {
      font-size: 12px;
      max-width: 300px;
    }

    .leaflet-popup-content a {
      color: #667eea;
      text-decoration: none;
      font-weight: bold;
    }

    .leaflet-popup-content a:hover {
      text-decoration: underline;
    }

    footer {
      background: #333;
      color: #999;
      padding: 10px 20px;
      font-size: 12px;
      text-align: center;
      border-top: 1px solid #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>å¤§é˜ªå¸‚ä¸­å¤®åŒº åœ°ç•ªãƒãƒªã‚´ãƒ³ ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
    <p>
      PMTiles + Leaflet | 27128__6_r_2024.geojson ã‹ã‚‰ç”Ÿæˆ
    </p>
  </header>

  <main>
    <div id="map"></div>

    <aside class="sidebar">
      <h2>èª­ã¿è¾¼ã¿ & æ¤œç´¢</h2>
      <ul id="statusList" class="status-list"></ul>

      <div class="info-panel">
        <dt>ğŸ” æ¤œç´¢ï¼ˆåœ°ç•ª / ä½æ‰€ï¼‰</dt>
        <dd>
          <input id="searchInput" type="text" placeholder="ä¾‹: 1-2-3 ã‚„ å ºç­‹æœ¬ç”º" style="width:100%; padding:6px; margin-bottom:6px;" />
          <div style="display:flex; gap:6px;">
            <button id="searchBtn" class="btn" style="flex:1">æ¤œç´¢</button>
            <button id="clearSearchBtn" class="btn" style="flex:1">ã‚¯ãƒªã‚¢</button>
          </div>
          <div id="searchResult" style="margin-top:8px; font-size:13px; color:#444"></div>
        </dd>

        <dt>ğŸ—ºï¸ ã‚ºãƒ¼ãƒ  ãƒ¬ãƒ™ãƒ«</dt>
        <dd id="zoomLevel">14</dd>

        <dt>ğŸ“ ä¸­å¿ƒåº§æ¨™</dt>
        <dd id="centerCoord">34.6901, 135.5023</dd>

        <dt>âœ“ èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒãƒªã‚´ãƒ³</dt>
        <dd id="tilesLoaded">0</dd>

        <dt>ğŸ“¦ ã‚½ãƒ¼ã‚¹</dt>
        <dd>
          <a href="https://github.com/kanri-srhd/hazard-viewer" target="_blank">hazard-viewer</a> / GitHub Pages
        </dd>
      </div>
    </aside>
  </main>

  <footer>
    <p>
      &copy; 2025 Hazard Viewer | Data: GeoJSON (å…¨å›½å¯¾å¿œ) | License: PDL 1.0 | è©³ç´°: <a href="../INSTALL_NATIONAL_DATA.md" style="color:#fff;text-decoration:underline;">å…¨å›½ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã‚¬ã‚¤ãƒ‰</a>
    </p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PMTiles library -->
  <script src="https://unpkg.com/pmtiles@3/dist/pmtiles.js"></script>

  <!-- Leaflet VectorGrid (for rendering vector tiles / MVT) -->
  <script src="https://unpkg.com/leaflet.vectorgrid/dist/Leaflet.VectorGrid.bundled.js"></script>

  <script>
    // =====================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆå…¨å›½å¯¾å¿œï¼‰
    // =====================================
    const statusList = document.getElementById('statusList');
    let cadastralGeojsonCache = {}; // åœ°åŸŸåˆ¥ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let currentRegion = 'osaka'; // ç¾åœ¨ã®é¸æŠåœ°åŸŸ
    const regionDataMap = {
      osaka: {
        name: 'å¤§é˜ªåºœï¼ˆä¸­å¤®åŒºï¼‰',
        url: '../geojson/27128__6_r_2024.geojson',
        bounds: [[34.63, 135.45], [34.73, 135.55]],
        center: [34.6901, 135.5023]
      },
      tokyo: {
        name: 'æ±äº¬éƒ½ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰',
        url: '../geojson/27128__6_r_2024.geojson', // å®Ÿè£…æ™‚ã«æ±äº¬ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆ
        bounds: [[35.62, 139.62], [35.82, 139.92]],
        center: [35.7, 139.77]
      },
      kyoto: {
        name: 'äº¬éƒ½åºœï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰',
        url: '../geojson/27128__6_r_2024.geojson', // å®Ÿè£…æ™‚ã«äº¬éƒ½ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆ
        bounds: [[34.77, 135.35], [35.35, 135.95]],
        center: [35.0, 135.65]
      }
    };

    function addStatus(message, type = 'info') {
      const li = document.createElement('li');
      li.className = 'status-item ' + type;
      li.textContent = message;
      statusList.insertBefore(li, statusList.firstChild);

      while (statusList.children.length > 10) {
        statusList.removeChild(statusList.lastChild);
      }
    }

    // =====================================
    // åœ°å›³åˆæœŸåŒ–
    // =====================================
    const map = L.map('map').setView([36.5, 137.5], 5); // åˆæœŸï¼šæ—¥æœ¬å…¨ä½“

    // ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆGSI æ·¡è‰²ï¼‰
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://maps.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>'
    }).addTo(map);

    addStatus('å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'success');

    // =====================================
    // åœ°ç±ãƒ»ãƒã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆåœ°åŸŸåˆ¥å¯¾å¿œï¼‰
    // =====================================
    var cadastralVectorLayer = null;
    var cadastralGeojson = null;
    var parcelLayerForSearch = null;
    var hazardLayers = {};

    function loadRegionData(regionKey) {
      currentRegion = regionKey;
      const regionInfo = regionDataMap[regionKey];
      
      if (!regionInfo) {
        addStatus('ç„¡åŠ¹ãªåœ°åŸŸã‚³ãƒ¼ãƒ‰: ' + regionKey, 'error');
        return;
      }
      
      addStatus(regionInfo.name + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
      
      // æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ã‚’å‰Šé™¤
      if (cadastralVectorLayer) {
        map.removeLayer(cadastralVectorLayer);
      }
      
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã€ãªã‘ã‚Œã° fetch
      if (cadastralGeojsonCache[regionKey]) {
        cadastralGeojson = cadastralGeojsonCache[regionKey];
        displayCadastralLayer();
      } else {
        fetch(regionInfo.url)
          .then(res => res.json())
          .then(geojson => {
            cadastralGeojsonCache[regionKey] = geojson;
            cadastralGeojson = geojson;
            displayCadastralLayer();
            
            // åœ°åŸŸã®å¢ƒç•Œã«ã‚ºãƒ¼ãƒ 
            map.fitBounds(regionInfo.bounds);
            
            addStatus(regionInfo.name + ' ã®åœ°ç±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (' + geojson.features.length + ' ä»¶)', 'success');
          })
          .catch(err => {
            console.error('Data load error:', err);
            addStatus(regionInfo.name + ' ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          });
      }
    }
    
    function displayCadastralLayer() {
      if (!cadastralGeojson) return;
      
      const cadastralStyle = {
        color: '#333',
        weight: 1,
        opacity: 1,
        fillColor: '#ffcc00',
        fillOpacity: 0.4
      };

      cadastralVectorLayer = L.geoJSON(cadastralGeojson, {
        style: cadastralStyle,
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var popupHtml = '<div style="font-size:12px; max-width:300px;"><strong>åœ°ç±</strong><br>';
          if (props['å¤§å­—']) popupHtml += 'å¤§å­—: ' + props['å¤§å­—'] + '<br>';
          if (props['ç”º']) popupHtml += 'ç”º: ' + props['ç”º'] + '<br>';
          if (props['åœ°ç•ª']) popupHtml += '<strong>åœ°ç•ª: ' + props['åœ°ç•ª'] + '</strong><br>';
          if (props['ä½æ‰€']) popupHtml += 'ä½æ‰€: ' + props['ä½æ‰€'] + '<br>';
          if (props['ç²¾åº¦']) popupHtml += 'ç²¾åº¦åŒºåˆ†: ' + props['ç²¾åº¦'] + '<br>';
          
          // Google Maps ãƒªãƒ³ã‚¯
          if (feature.geometry.type === 'Polygon') {
            var coords = feature.geometry.coordinates[0][0];
            var lat = coords[1];
            var lng = coords[0];
            popupHtml += '<a href="https://maps.google.com/?q=' + lat + ',' + lng + '" target="_blank">ğŸ“ Google Maps ã§é–‹ã</a>';
          }
          popupHtml += '</div>';
          
          layer.bindPopup(popupHtml);
          
          layer.on('mouseover', function() {
            this.setStyle({
              fillColor: '#ff9800',
              fillOpacity: 0.6,
              weight: 2
            });
          });
          layer.on('mouseout', function() {
            this.setStyle({
              fillColor: '#ffcc00',
              fillOpacity: 0.4,
              weight: 1
            });
          });
          
          layer.on('click', function() {
            this.openPopup();
          });
        }
      });

      cadastralVectorLayer.addTo(map);
      parcelLayerForSearch = cadastralVectorLayer;
      
      updateLayerControls();
    }

    // =====================================
    // GeoJSON ãƒã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¨å›½å¯¾å¿œï¼‰
    // =====================================
        var featureCount = geojson.features.length;
        document.getElementById('tilesLoaded').textContent = featureCount;
        addStatus('å¤§é˜ªå¸‚ä¸­å¤®åŒºåœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† (' + featureCount + ' ãƒãƒªã‚´ãƒ³)', 'success');
        return geojson;
      })
      .catch(function(err) {
        console.error('GeoJSON èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
        addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
        throw err;
      });

    // ãƒã‚¶ãƒ¼ãƒ‰ GeoJSON ãƒ¬ã‚¤ãƒ¤ã‚’èª­ã¿è¾¼ã¿
    function loadHazard(name, url, style) {
      addStatus(name + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
      return fetch(url)
        .then(function(r){ return r.json(); })
        .then(function(gj){
          var layer = L.geoJSON(gj, {
            style: style,
            onEachFeature: function(f, lyr){
              var p = f.properties || {};
              var popup = '<div style="font-size:12px;">';
              popup += '<strong>' + (p['name'] || name) + '</strong><br>';
              popup += (p['hazard_type']? ('ç¨®é¡: '+p['hazard_type']+'<br>') : '');
              if (p['severity'] || p['level']) popup += 'å±é™ºåº¦: ' + (p['severity'] || p['level']) + '<br>';
              if (p['source']) popup += 'å‡ºå…¸: ' + p['source'] + '<br>';
              popup += '</div>';
              lyr.bindPopup(popup);
            }
          });
          hazardLayers[name] = layer;
          addStatus(name + ' èª­ã¿è¾¼ã¿å®Œäº† (' + gj.features.length + ' ä»¶)', 'success');
          return layer;
        })
        .catch(function(err){ addStatus(name + ' èª­ã¿è¾¼ã¿å¤±æ•—', 'error'); console.warn(err); });
    }

    // ã‚¹ã‚¿ã‚¤ãƒ«è¦ä»¶ã«åˆã‚ã›ã‚‹
    var floodStyle = { color:'#0b66ff', weight:1, fillColor:'#0b66ff', fillOpacity:0.3 };
    var landslideStyle = { color:'#ff8c00', weight:1, fillColor:'#ff8c00', fillOpacity:0.3 };
    var tsunamiStyle = { color:'#00c8d8', weight:1, fillColor:'#00c8d8', fillOpacity:0.3 };

    // åœ°ç±ï¼ˆGeoJSONï¼‰ã¨ãƒã‚¶ãƒ¼ãƒ‰ï¼ˆ3ã¤ï¼‰ã®ã™ã¹ã¦ã‚’èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ¬ã‚¤ãƒ¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
    Promise.all([
      cadastralPromise,
      loadHazard('æ´ªæ°´', '../geojson/hazard_sample_flood_osaka.geojson', floodStyle),
      loadHazard('åœŸç ‚ç½å®³', '../geojson/hazard_sample_landslide_osaka.geojson', landslideStyle),
      loadHazard('æ´¥æ³¢', '../geojson/hazard_sample_tsunami_osaka.geojson', tsunamiStyle)
    ]).then(function(results){
      // ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã€ãƒ¬ã‚¤ãƒ¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
      if (cadastralVectorLayer) {
        var overlays = {
          'åœ°ç±': cadastralVectorLayer,
          'æ´ªæ°´': hazardLayers['æ´ªæ°´'],
          'åœŸç ‚ç½å®³': hazardLayers['åœŸç ‚ç½å®³'],
          'æ´¥æ³¢': hazardLayers['æ´¥æ³¢']
        };
        L.control.layers(null, overlays, {collapsed:false}).addTo(map);
        addStatus('ãƒ¬ã‚¤ãƒ¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
      } else {
        addStatus('ãƒ¬ã‚¤ãƒ¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¿½åŠ å¤±æ•—: åœ°ç±ãƒ¬ã‚¤ãƒ¤ãŒ null ã§ã™', 'error');
      }
    }).catch(function(err){
      console.error('ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
      addStatus('ä¸€éƒ¨ã®ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    });

    // æ³¨: PMTiles ã¯ MapLibre GL JS ç­‰ã®ãƒ™ã‚¯ãƒˆãƒ«ã‚¿ã‚¤ãƒ«å¯¾å¿œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ã®é€£æºã‚’æ¨å¥¨
    // æœ¬å®Ÿè£…ã¯ GeoJSON ãƒ™ãƒ¼ã‚¹ã®é«˜é€Ÿè¡¨ç¤ºã«æœ€é©åŒ–ã—ã¦ã„ã¾ã™

    // =====================================
    // ãƒã‚¶ãƒ¼ãƒ‰ GeoJSON ãƒ¬ã‚¤ãƒ¤ã‚’èª­ã¿è¾¼ã¿
    // =====================================

    // =====================================
    // æ¤œç´¢æ©Ÿèƒ½
    // =====================================
    var currentHighlight = null;
    function clearHighlight(){ if (currentHighlight) { map.removeLayer(currentHighlight); currentHighlight = null; } }

    document.getElementById('searchBtn').addEventListener('click', function(){
      var q = document.getElementById('searchInput').value.trim();
      if (!q) { document.getElementById('searchResult').textContent = 'æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
      if (!cadastralGeojson) { document.getElementById('searchResult').textContent = 'æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™'; return; }

      var results = [];
      var ql = q.toLowerCase();
      cadastralGeojson.features.forEach(function(f){
        var p = f.properties || {};
        var keys = ['åœ°ç•ª','ä½æ‰€','å¤§å­—','ç”º','chiban','address'];
        for (var i=0;i<keys.length;i++){
          var v = p[keys[i]] || '';
          if (typeof v === 'string' && v.toLowerCase().indexOf(ql) !== -1) { results.push(f); break; }
        }
      });

      if (results.length === 0){
        document.getElementById('searchResult').textContent = 'è©²å½“ãªã—';
        return;
      }

      document.getElementById('searchResult').textContent = results.length + ' ä»¶ãƒ’ãƒƒãƒˆ';
      // æœ€åˆã®çµæœã«ã‚ºãƒ¼ãƒ 
      var feat = results[0];
      var bounds = L.geoJSON(feat).getBounds();
      map.fitBounds(bounds.pad(1.2));

      clearHighlight();
      currentHighlight = L.geoJSON(feat, {style:{color:'#333', weight:2, fillColor:'#ffcc00', fillOpacity:0.6}}).addTo(map);

      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
      var props = feat.properties || {};
      var popupHtml = '<div style="font-size:12px; max-width:300px;"><strong>åœ°ç±</strong><br>';
      if (props['å¤§å­—']) popupHtml += 'å¤§å­—: ' + props['å¤§å­—'] + '<br>';
      if (props['ç”º']) popupHtml += 'ç”º: ' + props['ç”º'] + '<br>';
      if (props['åœ°ç•ª']) popupHtml += '<strong>åœ°ç•ª: ' + props['åœ°ç•ª'] + '</strong><br>';
      if (props['ä½æ‰€']) popupHtml += 'ä½æ‰€: ' + props['ä½æ‰€'] + '<br>';
      // center of bounds
      var center = bounds.getCenter();
      popupHtml += '<a href="https://maps.google.com/?q=' + center.lat + ',' + center.lng + '" target="_blank">ğŸ“ Google Maps ã§é–‹ã</a>';
      popupHtml += '</div>';
      L.popup().setLatLng(center).setContent(popupHtml).openOn(map);
    });

    document.getElementById('clearSearchBtn').addEventListener('click', function(){
      document.getElementById('searchInput').value = '';
      document.getElementById('searchResult').textContent = '';
      clearHighlight();
      map.closePopup();
    });

    // =====================================
    // åœ°å›³æ“ä½œç›£è¦–
    // =====================================

    map.on('zoomend', function() {
      document.getElementById('zoomLevel').textContent = map.getZoom();
    });

    map.on('moveend', function() {
      var center = map.getCenter();
      document.getElementById('centerCoord').textContent = center.lat.toFixed(4) + ', ' + center.lng.toFixed(4);
    });

    addStatus('ãƒ“ãƒ¥ãƒ¼ã‚¢æº–å‚™å®Œäº† - ãƒãƒªã‚´ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç•ªæƒ…å ±ã‚’è¡¨ç¤º', 'success');
  </script>
</body>
</html>
