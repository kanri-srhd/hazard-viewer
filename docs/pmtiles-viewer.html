<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¤§é˜ªå¸‚ä¸­å¤®åŒº åœ°ç•ªãƒãƒªã‚´ãƒ³ - PMTiles ãƒ“ãƒ¥ãƒ¼ã‚¢</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    header p {
      font-size: 14px;
      opacity: 0.9;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #map {
      flex: 1;
      background: #e0e0e0;
    }

    .sidebar {
      width: 300px;
      background: white;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 15px;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar h2 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .status-list {
      list-style: none;
      margin-bottom: 15px;
    }

    .status-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #f9f9f9;
      border-left: 3px solid #667eea;
      font-size: 13px;
      color: #555;
      border-radius: 2px;
    }

    .status-item.loading {
      border-left-color: #ff9800;
      background: #fff8f0;
    }

    .status-item.success {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }

    .status-item.error {
      border-left-color: #f44336;
      background: #fef1f1;
    }

    .info-panel {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      font-size: 12px;
      margin-top: 10px;
    }

    .info-panel dt {
      font-weight: bold;
      color: #333;
      margin-top: 5px;
    }

    .info-panel dd {
      color: #666;
      margin-left: 10px;
      margin-bottom: 5px;
      word-break: break-word;
    }

    .leaflet-popup-content {
      font-size: 12px;
      max-width: 300px;
    }

    .leaflet-popup-content a {
      color: #667eea;
      text-decoration: none;
      font-weight: bold;
    }

    .leaflet-popup-content a:hover {
      text-decoration: underline;
    }

    footer {
      background: #333;
      color: #999;
      padding: 10px 20px;
      font-size: 12px;
      text-align: center;
      border-top: 1px solid #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>å¤§é˜ªå¸‚ä¸­å¤®åŒº åœ°ç•ªãƒãƒªã‚´ãƒ³ ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
    <p>
      PMTiles + Leaflet | 27128__6_r_2024.geojson ã‹ã‚‰ç”Ÿæˆ
    </p>
  </header>

  <main>
    <div id="map"></div>

    <aside class="sidebar">
      <h2>èª­ã¿è¾¼ã¿çŠ¶æ…‹</h2>
      <ul id="statusList" class="status-list"></ul>

      <div class="info-panel">
        <dt>ğŸ—ºï¸ ã‚ºãƒ¼ãƒ  ãƒ¬ãƒ™ãƒ«</dt>
        <dd id="zoomLevel">14</dd>

        <dt>ğŸ“ ä¸­å¿ƒåº§æ¨™</dt>
        <dd id="centerCoord">34.6901, 135.5023</dd>

        <dt>âœ“ èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒãƒªã‚´ãƒ³</dt>
        <dd id="tilesLoaded">0</dd>

        <dt>ğŸ“¦ ã‚½ãƒ¼ã‚¹</dt>
        <dd>
          <a href="https://github.com/kanri-srhd/hazard-viewer" target="_blank">hazard-viewer</a> / GitHub Pages
        </dd>
      </div>
    </aside>
  </main>

  <footer>
    <p>
      &copy; 2025 Hazard Viewer | Data: å¤§é˜ªå¸‚ä¸­å¤®åŒº chuo-ku.pmtiles (from 27128__6_r_2024.geojson) | License: PDL 1.0
    </p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PMTiles library -->
  <script src="https://unpkg.com/pmtiles@3/dist/pmtiles.js"></script>

  <script>
    // =====================================
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«ç®¡ç†
    // =====================================
    const statusList = document.getElementById('statusList');

    function addStatus(message, type = 'info') {
      const li = document.createElement('li');
      li.className = 'status-item ' + type;
      li.textContent = message;
      statusList.insertBefore(li, statusList.firstChild);

      while (statusList.children.length > 10) {
        statusList.removeChild(statusList.lastChild);
      }
    }

    // =====================================
    // åœ°å›³åˆæœŸåŒ–
    // =====================================
    const map = L.map('map').setView([34.6901, 135.5023], 14);

    // ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—ï¼ˆGSI æ·¡è‰²ï¼‰
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="https://maps.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>'
    }).addTo(map);

    addStatus('åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'success');

    // =====================================
    // GeoJSON åœ°ç±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    // =====================================

    addStatus('å¤§é˜ªå¸‚ä¸­å¤®åŒºåœ°ç±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');

    fetch('../geojson/27128__6_r_2024.geojson')
      .then(function(res) {
        return res.json();
      })
      .then(function(geojson) {
        console.log('Cadastral parcels loaded:', geojson.features.length);

        // ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
        var layerStyle = {
          color: '#333',
          weight: 1,
          opacity: 1,
          fillColor: '#ffcc00',
          fillOpacity: 0.4
        };

        // GeoJSON ãƒ¬ã‚¤ãƒ¤ã‚’ä½œæˆ
        var parcelLayer = L.geoJSON(geojson, {
          style: layerStyle,
          onEachFeature: function(feature, layer) {
            var props = feature.properties || {};

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— HTML ã‚’ç”Ÿæˆ
            var popupHtml = '<div style="font-size: 12px; max-width: 300px;">';
            popupHtml += '<strong>å¤§é˜ªå¸‚ä¸­å¤®åŒº</strong><br>';

            if (props['å¤§å­—'])
              popupHtml += 'å¤§å­—: ' + props['å¤§å­—'] + '<br>';
            if (props['ç”º'])
              popupHtml += 'ç”º: ' + props['ç”º'] + '<br>';
            if (props['åœ°ç•ª'])
              popupHtml += '<strong>åœ°ç•ª: ' + props['åœ°ç•ª'] + '</strong><br>';
            if (props['ä½æ‰€'])
              popupHtml += 'ä½æ‰€: ' + props['ä½æ‰€'] + '<br>';
            if (props['ç²¾åº¦'])
              popupHtml += 'ç²¾åº¦åŒºåˆ†: ' + props['ç²¾åº¦'] + '<br>';

            // Google Maps ãƒªãƒ³ã‚¯
            if (feature.geometry.type === 'Polygon') {
              var coords = feature.geometry.coordinates[0][0];
              var lat = coords[1];
              var lng = coords[0];
              popupHtml += '<a href="https://maps.google.com/?q=' + lat + ',' + lng + '" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">ğŸ“ Google Maps ã§é–‹ã</a>';
            }

            popupHtml += '</div>';

            layer.bindPopup(popupHtml);

            // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            layer.on('mouseover', function() {
              this.setStyle({
                fillColor: '#ff9800',
                fillOpacity: 0.6,
                weight: 2
              });
            });

            layer.on('mouseout', function() {
              this.setStyle({
                fillColor: '#ffcc00',
                fillOpacity: 0.4,
                weight: 1
              });
            });

            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
            layer.on('click', function() {
              this.openPopup();
            });
          }
        });

        parcelLayer.addTo(map);
        var featureCount = geojson.features.length;
        document.getElementById('tilesLoaded').textContent = featureCount;

        addStatus(
          'å¤§é˜ªå¸‚ä¸­å¤®åŒºåœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† (' + featureCount + ' ãƒãƒªã‚´ãƒ³)',
          'success'
        );
      })
      .catch(function(err) {
        console.error('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
        addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
      });

    // =====================================
    // åœ°å›³æ“ä½œç›£è¦–
    // =====================================

    map.on('zoomend', function() {
      document.getElementById('zoomLevel').textContent = map.getZoom();
    });

    map.on('moveend', function() {
      var center = map.getCenter();
      document.getElementById('centerCoord').textContent = center.lat.toFixed(4) + ', ' + center.lng.toFixed(4);
    });

    addStatus('ãƒ“ãƒ¥ãƒ¼ã‚¢æº–å‚™å®Œäº† - ãƒãƒªã‚´ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦åœ°ç•ªæƒ…å ±ã‚’è¡¨ç¤º', 'success');
  </script>
</body>
</html>
