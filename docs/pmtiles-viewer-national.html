<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ (GeoJSON + Leaflet)</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }

    header h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }

    header p {
      font-size: 13px;
      opacity: 0.9;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #map {
      flex: 1;
      background: #e0e0e0;
    }

    .sidebar {
      width: 320px;
      background: white;
      border-left: 1px solid #ddd;
      overflow-y: auto;
      padding: 15px;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar h2 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }

    .region-selector {
      margin-bottom: 12px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .region-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .layer-controls {
      margin-bottom: 12px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .layer-controls h3 {
      font-size: 13px;
      margin-bottom: 8px;
      color: #333;
    }

    .layer-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .layer-item input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }

    .layer-item label {
      cursor: pointer;
      user-select: none;
    }

    .search-box {
      margin-bottom: 12px;
    }

    .search-box input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 5px;
    }

    .search-box button {
      width: 100%;
      padding: 8px;
      background: #0b66ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .search-box button:hover {
      background: #0854cc;
    }

    .status-list {
      list-style: none;
      margin-bottom: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .status-item {
      padding: 8px;
      margin-bottom: 5px;
      background: #f9f9f9;
      border-left: 3px solid #667eea;
      font-size: 11px;
      color: #555;
      border-radius: 2px;
    }

    .status-item.loading {
      border-left-color: #ff9800;
      background: #fff8f0;
    }

    .status-item.success {
      border-left-color: #4caf50;
      background: #f1f8f4;
    }

    .status-item.error {
      border-left-color: #f44336;
      background: #fef1f1;
    }

    .info-box {
      background: #f0f8ff;
      border: 1px solid #90caf9;
      border-radius: 4px;
      padding: 8px;
      font-size: 11px;
      color: #333;
      line-height: 1.4;
    }

    footer {
      background: #333;
      color: white;
      padding: 10px 20px;
      text-align: center;
      font-size: 12px;
      border-top: 1px solid #ddd;
    }

    footer a {
      color: #90caf9;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
    <p>åœ°ç±ãƒ»æ´ªæ°´ãƒ»åœŸç ‚ç½å®³ãƒ»æ´¥æ³¢ã®çµ±åˆè¡¨ç¤º (GeoJSON + MapLibre GLå¯¾å¿œ)</p>
  </header>

  <main>
    <div id="map"></div>

    <aside class="sidebar">
      <h2>åœ°åŸŸé¸æŠ</h2>
      <div class="region-selector">
        <select id="regionSelect" onchange="switchRegion()">
          <option value="national">ğŸ—¾ å…¨å›½</option>
          <option value="osaka">ğŸ¯ å¤§é˜ªåºœï¼ˆä¸­å¤®åŒºï¼‰</option>
          <option value="tokyo">ğŸ—¼ æ±äº¬éƒ½ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
          <option value="kyoto">â›©ï¸ äº¬éƒ½åºœï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰</option>
        </select>
      </div>

      <h2>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
      <ul id="statusList" class="status-list"></ul>

      <h2>ãƒ¬ã‚¤ãƒ¤è¡¨ç¤º</h2>
      <div class="layer-controls">
        <div class="layer-item">
          <input type="checkbox" id="toggle-cadastral" checked onchange="toggleLayer('cadastral')">
          <label for="toggle-cadastral">åœ°ç±</label>
        </div>
        <div class="layer-item">
          <input type="checkbox" id="toggle-flood" checked onchange="toggleLayer('flood')">
          <label for="toggle-flood">æ´ªæ°´</label>
        </div>
        <div class="layer-item">
          <input type="checkbox" id="toggle-landslide" checked onchange="toggleLayer('landslide')">
          <label for="toggle-landslide">åœŸç ‚ç½å®³</label>
        </div>
        <div class="layer-item">
          <input type="checkbox" id="toggle-tsunami" checked onchange="toggleLayer('tsunami')">
          <label for="toggle-tsunami">æ´¥æ³¢</label>
        </div>
      </div>

      <h2>æ¤œç´¢</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="åœ°ç•ª / ä½æ‰€ã§æ¤œç´¢...">
        <button onclick="searchParcel()">ğŸ” æ¤œç´¢</button>
      </div>

      <div class="info-box">
        <strong>â„¹ï¸ ä½¿ç”¨æ–¹æ³•</strong><br>
        â€¢ åœ°åŸŸã‚’é¸æŠã™ã‚‹ã¨ãƒãƒƒãƒ—ãŒåˆ‡ã‚Šæ›¿ã‚ã‚Šã¾ã™<br>
        â€¢ ãƒã‚§ãƒƒã‚¯ã§ãƒ¬ã‚¤ãƒ¤ã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ<br>
        â€¢ åœ°ç•ªãƒ»ä½æ‰€ã§æ¤œç´¢å¯èƒ½<br>
        â€¢ ãƒãƒªã‚´ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°æƒ…å ±è¡¨ç¤º<br>
        â€¢ ãƒ›ãƒãƒ¼ã§å¼·èª¿è¡¨ç¤º
      </div>
    </aside>
  </main>

  <footer>
    <p>&copy; 2025 Hazard Viewer | License: PDL 1.0 | <a href="../INSTALL_NATIONAL_DATA.md">å…¨å›½ãƒ‡ãƒ¼ã‚¿å¯¾å¿œã‚¬ã‚¤ãƒ‰</a></p>
  </footer>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // =====================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // =====================================
    const statusList = document.getElementById('statusList');
    let map;
    let cadastralGeojsonCache = {};
    let layerCache = {};
    let currentRegion = 'national';
    
    const regionDataMap = {
      national: {
        name: 'å…¨å›½',
        center: [36.5, 137.5],
        zoom: 5,
        datasets: []
      },
      osaka: {
        name: 'å¤§é˜ªåºœï¼ˆä¸­å¤®åŒºï¼‰',
        center: [34.6901, 135.5023],
        zoom: 14,
        datasets: [
          { name: 'åœ°ç±', url: '../geojson/27128__6_r_2024.geojson', layer: 'cadastral' }
        ]
      },
      tokyo: {
        name: 'æ±äº¬éƒ½ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰',
        center: [35.7, 139.77],
        zoom: 12,
        datasets: [
          { name: 'åœ°ç±', url: '../geojson/27128__6_r_2024.geojson', layer: 'cadastral' }
        ]
      },
      kyoto: {
        name: 'äº¬éƒ½åºœï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰',
        center: [35.0, 135.65],
        zoom: 12,
        datasets: [
          { name: 'åœ°ç±', url: '../geojson/27128__6_r_2024.geojson', layer: 'cadastral' }
        ]
      }
    };

    function addStatus(msg, type = 'info') {
      const li = document.createElement('li');
      li.className = 'status-item ' + type;
      li.textContent = msg;
      statusList.insertBefore(li, statusList.firstChild);
      while (statusList.children.length > 10) {
        statusList.removeChild(statusList.lastChild);
      }
    }

    // =====================================
    // ãƒãƒƒãƒ—åˆæœŸåŒ–
    // =====================================
    function initMap() {
      addStatus('ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
      
      map = L.map('map').setView([36.5, 137.5], 5);
      
      L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://maps.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>'
      }).addTo(map);
      
      addStatus('ãƒãƒƒãƒ—åˆæœŸåŒ–å®Œäº†', 'success');
      loadRegionData('osaka'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¤§é˜ªã‚’èª­ã¿è¾¼ã¿
    }

    // =====================================
    // åœ°åŸŸåˆ‡ã‚Šæ›¿ãˆ
    // =====================================
    function switchRegion() {
      const regionKey = document.getElementById('regionSelect').value;
      currentRegion = regionKey;
      loadRegionData(regionKey);
    }

    function loadRegionData(regionKey) {
      const regionInfo = regionDataMap[regionKey];
      
      if (!regionInfo) {
        addStatus('ç„¡åŠ¹ãªåœ°åŸŸ: ' + regionKey, 'error');
        return;
      }

      // æ—¢å­˜ãƒ¬ã‚¤ãƒ¤ã‚’å‰Šé™¤
      ['cadastral', 'flood', 'landslide', 'tsunami'].forEach(layer => {
        if (layerCache[layer]) {
          map.removeLayer(layerCache[layer]);
          layerCache[layer] = null;
        }
      });

      // ãƒãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
      map.setView(regionInfo.center, regionInfo.zoom);
      
      addStatus(regionInfo.name + ' ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');

      // åœ°ç±ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      if (regionKey === 'osaka') {
        fetch('../geojson/27128__6_r_2024.geojson')
          .then(r => r.json())
          .then(geojson => {
            displayCadastralLayer(geojson);
            
            // ãƒã‚¶ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
            loadHazardLayers();
            
            addStatus(regionInfo.name + ' ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
          })
          .catch(err => {
            console.error('Data load error:', err);
            addStatus(regionInfo.name + ' ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—', 'error');
          });
      } else {
        addStatus(regionInfo.name + ' ã¯ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤§é˜ªã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼‰', 'info');
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å†åˆ©ç”¨
        if (cadastralGeojsonCache['osaka']) {
          displayCadastralLayer(cadastralGeojsonCache['osaka']);
        }
      }
    }

    function displayCadastralLayer(geojson) {
      cadastralGeojsonCache[currentRegion] = geojson;

      const cadastralStyle = {
        color: '#333',
        weight: 1,
        fillColor: '#ffcc00',
        fillOpacity: 0.4
      };

      const cadastralLayer = L.geoJSON(geojson, {
        style: cadastralStyle,
        onEachFeature: (feature, layer) => {
          const props = feature.properties || {};
          let popupHtml = '<div style="font-size:12px; max-width:300px;"><strong>åœ°ç±</strong><br>';
          if (props['å¤§å­—']) popupHtml += 'å¤§å­—: ' + props['å¤§å­—'] + '<br>';
          if (props['ç”º']) popupHtml += 'ç”º: ' + props['ç”º'] + '<br>';
          if (props['åœ°ç•ª']) popupHtml += '<strong>åœ°ç•ª: ' + props['åœ°ç•ª'] + '</strong><br>';
          if (props['ä½æ‰€']) popupHtml += 'ä½æ‰€: ' + props['ä½æ‰€'] + '<br>';
          if (props['ç²¾åº¦']) popupHtml += 'ç²¾åº¦: ' + props['ç²¾åº¦'] + '<br>';
          
          if (feature.geometry.type === 'Polygon') {
            const coords = feature.geometry.coordinates[0][0];
            popupHtml += '<a href="https://maps.google.com/?q=' + coords[1] + ',' + coords[0] + '" target="_blank">ğŸ“ Maps</a>';
          }
          popupHtml += '</div>';
          
          layer.bindPopup(popupHtml);
          layer.on('mouseover', () => {
            layer.setStyle({ fillColor: '#ff9800', fillOpacity: 0.6, weight: 2 });
          });
          layer.on('mouseout', () => {
            layer.setStyle({ fillColor: '#ffcc00', fillOpacity: 0.4, weight: 1 });
          });
          layer.on('click', () => layer.openPopup());
        }
      });

      cadastralLayer.addTo(map);
      layerCache['cadastral'] = cadastralLayer;
    }

    // =====================================
    // ãƒã‚¶ãƒ¼ãƒ‰ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿
    // =====================================
    function loadHazardLayers() {
      const hazardData = [
        {
          name: 'flood',
          url: '../geojson/hazard_sample_flood_osaka.geojson',
          label: 'æ´ªæ°´',
          style: { color: '#0b66ff', weight: 1, fillColor: '#0b66ff', fillOpacity: 0.3 }
        },
        {
          name: 'landslide',
          url: '../geojson/hazard_sample_landslide_osaka.geojson',
          label: 'åœŸç ‚ç½å®³',
          style: { color: '#ff8c00', weight: 1, fillColor: '#ff8c00', fillOpacity: 0.3 }
        },
        {
          name: 'tsunami',
          url: '../geojson/hazard_sample_tsunami_osaka.geojson',
          label: 'æ´¥æ³¢',
          style: { color: '#00c8d8', weight: 1, fillColor: '#00c8d8', fillOpacity: 0.3 }
        }
      ];

      hazardData.forEach(data => {
        fetch(data.url)
          .then(r => r.json())
          .then(geojson => {
            const layer = L.geoJSON(geojson, {
              style: data.style,
              onEachFeature: (feature, layer) => {
                const props = feature.properties || {};
                let popup = '<strong>' + data.label + '</strong><br>';
                for (let key in props) {
                  popup += key + ': ' + props[key] + '<br>';
                }
                layer.bindPopup(popup);
              }
            });

            layer.addTo(map);
            layerCache[data.name] = layer;
            addStatus(data.label + ' èª­ã¿è¾¼ã¿å®Œäº†', 'success');
          })
          .catch(err => console.warn(data.label + ' read error:', err));
      });
    }

    // =====================================
    // ãƒ¬ã‚¤ãƒ¤è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    // =====================================
    function toggleLayer(layerName) {
      const checkbox = document.getElementById('toggle-' + layerName);
      if (layerCache[layerName]) {
        if (checkbox.checked) {
          map.addLayer(layerCache[layerName]);
        } else {
          map.removeLayer(layerCache[layerName]);
        }
      }
    }

    // =====================================
    // æ¤œç´¢æ©Ÿèƒ½
    // =====================================
    function searchParcel() {
      const query = document.getElementById('searchInput').value.trim();
      if (!query) {
        addStatus('æ¤œç´¢èªã‚’å…¥åŠ›', 'error');
        return;
      }

      const geojson = cadastralGeojsonCache[currentRegion];
      if (!geojson) {
        addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿æœªèª­ã¿è¾¼ã¿', 'error');
        return;
      }

      const results = geojson.features.filter(f => {
        const props = f.properties || {};
        const str = JSON.stringify(props).toLowerCase();
        return str.includes(query.toLowerCase());
      });

      if (results.length === 0) {
        addStatus('æ¤œç´¢çµæœãªã—', 'error');
        return;
      }

      addStatus(results.length + ' ä»¶ãƒ’ãƒƒãƒˆ', 'success');

      // æœ€åˆã®çµæœã«ã‚ºãƒ¼ãƒ 
      const first = results[0];
      const bounds = L.geoJSON(first).getBounds();
      map.fitBounds(bounds.pad(0.1));
    }

    // =====================================
    // åˆæœŸåŒ–
    // =====================================
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
    });
  </script>
</body>
</html>
