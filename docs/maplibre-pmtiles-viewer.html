<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ (PMTiles + MapLibre GL)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ—ºï¸</text></svg>">
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3/dist/index.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'MS PGothic', sans-serif;
            background: #f0f0f0;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 15px;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar h1 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: #0b66ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .search-box button:hover {
            background: #0854cc;
        }
        
        .status {
            background: #f9f9f9;
            border-left: 3px solid #0b66ff;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 2px;
            font-size: 12px;
            color: #333;
        }
        
        .status.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        
        .status.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .status.loading {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .status.loading::after {
            content: " â³";
        }
        
        .layer-controls {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .layer-controls h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .layer-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .info-box {
            background: #f0f8ff;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #333;
            line-height: 1.4;
        }
        
        .coord-display {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ddd;
            border-top-color: #0b66ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="sidebar">
        <h1>ğŸ—ºï¸ å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
        
        <div id="statusPanel"></div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="åœ°ç•ª / ä½æ‰€ã§æ¤œç´¢...">
            <button onclick="searchParcel()">ğŸ” æ¤œç´¢</button>
        </div>
        
        <div class="layer-controls">
            <h3>ğŸ“ ãƒ¬ã‚¤ãƒ¤è¡¨ç¤º</h3>
            <div class="layer-item">
                <input type="checkbox" id="toggle-cadastral" checked onchange="toggleLayer('cadastral')">
                <label for="toggle-cadastral">åœ°ç± (é»„è‰²)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-flood" checked onchange="toggleLayer('flood')">
                <label for="toggle-flood">æ´ªæ°´ (é’è‰²)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-landslide" checked onchange="toggleLayer('landslide')">
                <label for="toggle-landslide">åœŸç ‚ç½å®³ (æ©™è‰²)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-tsunami" checked onchange="toggleLayer('tsunami')">
                <label for="toggle-tsunami">æ´¥æ³¢ (æ°´è‰²)</label>
            </div>
        </div>
        
        <div class="info-box">
            <strong>â„¹ï¸ ä½¿ç”¨æ–¹æ³•</strong><br>
            â€¢ æ¤œç´¢: åœ°ç•ªãƒ»ä½æ‰€ã§è©²å½“ãƒãƒªã‚´ãƒ³ã‚’æ¤œç´¢<br>
            â€¢ ãƒã‚§ãƒƒã‚¯: ãƒ¬ã‚¤ãƒ¤ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ<br>
            â€¢ ã‚¯ãƒªãƒƒã‚¯: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º<br>
            â€¢ ã‚ºãƒ¼ãƒ : ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ« or ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ 
        </div>
        
        <div id="coordDisplay" class="coord-display"></div>
        <div id="detailPanel" class="detail-panel" style="margin-top:10px;padding:8px;border-radius:6px;border:1px solid #e6e6e6;background:#fff;">
            <strong>è©³ç´°æƒ…å ±</strong>
            <div id="detailContent" style="margin-top:8px;font-size:13px;color:#333;">åœ°å›³ä¸Šã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
    </div>
    
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    
    <!-- PMTiles Library -->
    <script src="https://unpkg.com/pmtiles@3/dist/index.js"></script>
    
    <script>
        // ==========================================
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚° & Service Worker ãƒªã‚»ãƒƒãƒˆ
        // ==========================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
            });
        }
        
        // ==========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ==========================================
        let map;
        let cadastralData = null;
        let layersEnabled = {
            cadastral: true,
            flood: true,
            landslide: true,
            tsunami: true
        };
        let p; // PMTiles Protocol instance
        
        // ==========================================
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ‘ãƒãƒ«ç®¡ç†
        // ==========================================
        function addStatus(msg, type = 'info') {
            const panel = document.getElementById('statusPanel');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.textContent = msg;
            panel.insertBefore(div, panel.firstChild);
            
            if (type !== 'loading') {
                setTimeout(() => div.style.opacity = '0.7', 2000);
            }
        }
        
        // ==========================================
        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        // ==========================================
        function initMap() {
            addStatus('ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
            
            // MapLibre GL äº’æ›ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆCORS ãƒ•ãƒªãƒ¼ï¼‰
            const style = {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors'
                    }
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm'
                    }
                ]
            };
            
            map = new maplibregl.Map({
                container: 'map',
                style: style,
                center: [136.5, 35.5], // æ—¥æœ¬ä¸­å¤®ï¼ˆæ„›çŸ¥çœŒï¼‰
                zoom: 5,
                pitch: 0,
                bearing: 0
            });
            
            map.on('load', () => {
                addStatus('ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                // PMTiles ã®ãƒ­ãƒ¼ãƒ‰ã‚’å°‘ã—é…å»¶ã•ã›ã‚‹ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
                setTimeout(() => {
                    initPMTiles();
                    setupEventHandlers();
                }, 500);
            });
            
            map.on('error', (err) => {
                console.error('Map error:', err);
                addStatus('ãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ' + err.error, 'error');
            });
        }
        
        // ==========================================
        // PMTiles ãƒ—ãƒ­ãƒˆã‚³ãƒ«åˆæœŸåŒ–
        // ==========================================
        function initPMTiles() {
            addStatus('PMTiles ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’åˆæœŸåŒ–ä¸­...', 'loading');
            
            // PMTiles ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if (typeof pmtiles === 'undefined' || !pmtiles.Protocol) {
                console.warn('PMTiles library not yet loaded, using GeoJSON fallback');
                addStatus('PMTiles ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæœªèª­ã¿è¾¼ã¿ â†’ GeoJSON ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯', 'info');
                loadGeoJSONFallback();
                return;
            }
            
            try {
                // PMTiles Protocol ã‚’ç™»éŒ²
                p = new pmtiles.Protocol();
                maplibregl.addProtocol('pmtiles', p.tile);
                
                addStatus('PMTiles ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç™»éŒ²æˆåŠŸ', 'success');
                
                // ãƒ¬ã‚¤ãƒ¤ã‚’ãƒ­ãƒ¼ãƒ‰
                loadPMTilesLayers();
            } catch (err) {
                console.error('PMTiles Protocol Error:', err);
                addStatus('PMTiles ãƒ—ãƒ­ãƒˆã‚³ãƒ«ç™»éŒ²å¤±æ•—: ' + err.message, 'error');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: GeoJSON ã‚’ä½¿ç”¨
                loadGeoJSONFallback();
            }
        }
        
        // ==========================================
        // PMTiles ãƒ¬ã‚¤ãƒ¤ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆMapLibre GL ãƒã‚¤ãƒ†ã‚£ãƒ–ï¼‰
        // ==========================================
        function loadPMTilesLayers() {
            // åœ°ç± PMTiles
            addStatus('åœ°ç± PMTiles ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
            
            // PMTiles URL ã‚¹ã‚­ãƒ¼ãƒ ï¼ˆGitHub Pages ç’°å¢ƒå¯¾å¿œï¼‰
            const baseUrl = window.location.pathname.includes('/docs/') 
                ? '/hazard-viewer/docs/data/'
                : './data/';
            const cadastralUrl = 'pmtiles://' + window.location.origin + baseUrl + 'cadastral_national.pmtiles';
            
            try {
                // åœ°ç±ãƒ¬ã‚¤ãƒ¤ï¼ˆãƒãƒªã‚´ãƒ³ï¼‰
                map.addSource('cadastral-source', {
                    type: 'vector',
                    url: cadastralUrl
                });
                
                map.addLayer({
                    id: 'cadastral-layer',
                    type: 'fill',
                    source: 'cadastral-source',
                    'source-layer': 'cadastral',
                    paint: {
                        'fill-color': '#ffcc00',
                        'fill-opacity': 0.4,
                        'fill-outline-color': '#333'
                    }
                });
                
                map.addLayer({
                    id: 'cadastral-outline',
                    type: 'line',
                    source: 'cadastral-source',
                    'source-layer': 'cadastral',
                    paint: {
                        'line-color': '#333',
                        'line-width': 1
                    }
                });
                
                addStatus('åœ°ç±ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                
                // ãƒã‚¶ãƒ¼ãƒ‰ PMTiles ã‚’ãƒ­ãƒ¼ãƒ‰
                loadHazardPMTiles();
                
            } catch (err) {
                console.error('Cadastral layer error:', err);
                addStatus('åœ°ç±ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å¤±æ•—: ' + err.message, 'error');
            }
        }
        
        // ==========================================
        // ãƒã‚¶ãƒ¼ãƒ‰ PMTiles ã®ãƒ­ãƒ¼ãƒ‰
        // ==========================================
        function loadHazardPMTiles() {
            const baseUrl = window.location.pathname.includes('/docs/') 
                ? '/hazard-viewer/docs/data/'
                : './data/';
            const hazardUrl = 'pmtiles://' + window.location.origin + baseUrl + 'hazard_integrated_national.pmtiles';
            
            // æ´ªæ°´
            try {
                map.addSource('flood-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'flood-layer',
                    type: 'fill',
                    source: 'flood-source',
                    'source-layer': 'flood',
                    paint: {
                        'fill-color': '#0b66ff',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('æ´ªæ°´ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (err) {
                console.warn('Flood layer error:', err);
            }
            
            // åœŸç ‚ç½å®³
            try {
                map.addSource('landslide-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'landslide-layer',
                    type: 'fill',
                    source: 'landslide-source',
                    'source-layer': 'landslide',
                    paint: {
                        'fill-color': '#ff8c00',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('åœŸç ‚ç½å®³ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (err) {
                console.warn('Landslide layer error:', err);
            }
            
            // æ´¥æ³¢
            try {
                map.addSource('tsunami-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'tsunami-layer',
                    type: 'fill',
                    source: 'tsunami-source',
                    'source-layer': 'tsunami',
                    paint: {
                        'fill-color': '#00c8d8',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('æ´¥æ³¢ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            } catch (err) {
                console.warn('Tsunami layer error:', err);
            }
        }
        
        // ==========================================
        // GeoJSON ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆPMTiles æœªå¯¾å¿œç’°å¢ƒï¼‰
        // ==========================================
        function loadGeoJSONFallback() {
            addStatus('GeoJSON ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ', 'info');
            
            // åœ°ç± GeoJSON ã‚’ãƒ­ãƒ¼ãƒ‰
            addStatus('åœ°ç± GeoJSON ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'loading');
            fetch('../geojson/27128__6_r_2024.geojson')
                .then(r => r.json())
                .then(geojson => {
                    cadastralData = geojson;
                    
                    map.addSource('cadastral-source', {
                        type: 'geojson',
                        data: geojson
                    });
                    
                    map.addLayer({
                        id: 'cadastral-layer',
                        type: 'fill',
                        source: 'cadastral-source',
                        paint: {
                            'fill-color': '#ffcc00',
                            'fill-opacity': 0.4,
                            'fill-outline-color': '#333'
                        }
                    });
                    
                    map.addLayer({
                        id: 'cadastral-outline',
                        type: 'line',
                        source: 'cadastral-source',
                        paint: {
                            'line-color': '#333',
                            'line-width': 1
                        }
                    });
                    
                    addStatus('åœ°ç± GeoJSON èª­ã¿è¾¼ã¿å®Œäº† (' + geojson.features.length + ' ä»¶)', 'success');
                    
                    // ãƒã‚¶ãƒ¼ãƒ‰ GeoJSON ã‚’ãƒ­ãƒ¼ãƒ‰
                    loadHazardGeoJSON();
                })
                .catch(err => {
                    console.error('GeoJSON load error:', err);
                    addStatus('GeoJSON èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', 'error');
                });
        }
        
        // ==========================================
        // ãƒã‚¶ãƒ¼ãƒ‰ GeoJSON ã®ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        // ==========================================
        function loadHazardGeoJSON() {
            // æ´ªæ°´
            fetch('../geojson/hazard_sample_flood_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('flood-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'flood-layer',
                        type: 'fill',
                        source: 'flood-source',
                        paint: { 'fill-color': '#0b66ff', 'fill-opacity': 0.3 }
                    });
                    addStatus('æ´ªæ°´ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                })
                .catch(err => console.warn('Flood GeoJSON error:', err));
            
            // åœŸç ‚ç½å®³
            fetch('../geojson/hazard_sample_landslide_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('landslide-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'landslide-layer',
                        type: 'fill',
                        source: 'landslide-source',
                        paint: { 'fill-color': '#ff8c00', 'fill-opacity': 0.3 }
                    });
                    addStatus('åœŸç ‚ç½å®³ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                })
                .catch(err => console.warn('Landslide GeoJSON error:', err));
            
            // æ´¥æ³¢
            fetch('../geojson/hazard_sample_tsunami_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('tsunami-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'tsunami-layer',
                        type: 'fill',
                        source: 'tsunami-source',
                        paint: { 'fill-color': '#00c8d8', 'fill-opacity': 0.3 }
                    });
                    addStatus('æ´¥æ³¢ãƒ¬ã‚¤ãƒ¤èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                })
                .catch(err => console.warn('Tsunami GeoJSON error:', err));
        }
        
        // ==========================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        // ==========================================
        function setupEventHandlers() {
            // ã‚ºãƒ¼ãƒ ãƒ»ãƒ‘ãƒ³æ™‚ã«åº§æ¨™ã‚’æ›´æ–°
            map.on('mousemove', (e) => {
                const zoom = map.getZoom().toFixed(2);
                const lat = e.lngLat.lat.toFixed(4);
                const lng = e.lngLat.lng.toFixed(4);
                document.getElementById('coordDisplay').textContent = 
                    `ğŸ¯ Zoom: ${zoom} | Lat: ${lat} | Lng: ${lng}`;
            });
            
            // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆPMTiles ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ã‚¯ã‚¨ãƒªï¼‰
                // hover & click handling for cadastral
                let cadastralHover = null;
                map.on('mousemove', 'cadastral-layer', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    if (window.__pinnedPopup) return;
                    const props = (e.features && e.features[0] && e.features[0].properties) || {};
                    const brief = formatPropsBrief(props);
                    if (cadastralHover) cadastralHover.remove();
                    cadastralHover = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                        .setLngLat(e.lngLat)
                        .setHTML(brief)
                        .addTo(map);
                });
                map.on('mouseleave', 'cadastral-layer', () => {
                    map.getCanvas().style.cursor = '';
                    if (cadastralHover) { cadastralHover.remove(); cadastralHover = null; }
                });
                map.on('click', 'cadastral-layer', (e) => {
                    const features = (e.features && e.features.length) ? e.features : map.queryRenderedFeatures(e.point, { layers: ['cadastral-layer'] });
                    if (!features || features.length === 0) return;
                    const feature = features[0];
                    const props = feature.properties || {};
                    if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                    window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                        .setLngLat(e.lngLat)
                        .setHTML(formatPropsLong(props))
                        .addTo(map);
                    // try to zoom to polygon if available
                    try {
                        const geom = feature.geometry || (feature.layer && feature.layer.geometry);
                        if (geom && geom.type === 'Polygon') {
                            const coords = geom.coordinates[0];
                            const bounds = coords.reduce((acc, c) => ({
                                minLng: Math.min(acc.minLng, c[0]),
                                maxLng: Math.max(acc.maxLng, c[0]),
                                minLat: Math.min(acc.minLat, c[1]),
                                maxLat: Math.max(acc.maxLat, c[1])
                            }), { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                            map.fitBounds([[bounds.minLng, bounds.minLat], [bounds.maxLng, bounds.maxLat]], { padding: 20 });
                        }
                    } catch (err) {}
                    showDetail(props, e.lngLat);
                });

                // hazard layers: simple hover and click pinned popup + detail
                ['flood','landslide','tsunami'].forEach(id => {
                    let hover = null;
                    map.on('mousemove', id + '-layer', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        if (window.__pinnedPopup) return;
                        const props = (e.features && e.features[0] && e.features[0].properties) || {};
                        const brief = formatPropsBrief(props) || ('<div>' + id + '</div>');
                        if (hover) hover.remove();
                        hover = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(brief)
                            .addTo(map);
                    });
                    map.on('mouseleave', id + '-layer', () => { map.getCanvas().style.cursor = ''; if (hover) { hover.remove(); hover = null; } });
                    map.on('click', id + '-layer', (e) => {
                        const features = (e.features && e.features.length) ? e.features : map.queryRenderedFeatures(e.point, { layers: [id + '-layer'] });
                        if (!features || features.length === 0) return;
                        const props = features[0].properties || {};
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                        window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(formatPropsLong(props))
                            .addTo(map);
                        showDetail(props, e.lngLat);
                    });
                });

                // clicking map background clears pinned popup/detail
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['cadastral-layer','flood-layer','landslide-layer','tsunami-layer'] });
                    if (!features || features.length === 0) {
                        clearDetail();
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                    }
                });
            }

            // Utilities for detail display (global scope)
            function formatPropsBrief(props) {
                if (!props) return '<div>æƒ…å ±ãªã—</div>';
                const name = props.name || props.chiban || props.address || props.block || '';
                return `<div style="font-size:12px;"><strong>${name}</strong></div>`;
            }

            function formatPropsLong(props) {
                if (!props) return '<div>æƒ…å ±ãªã—</div>';
                let html = '<div style="font-size:13px;line-height:1.4;">';
                Object.keys(props).forEach(k => {
                    const v = props[k];
                    if (v === null || v === undefined || v === '') return;
                    html += `<div><strong>${k}</strong>: ${String(v)}</div>`;
                });
                html += '</div>';
                return html;
            }

            function showDetail(props, lngLat) {
                const el = document.getElementById('detailContent');
                if (!el) return;
                let html = '<div style="font-size:13px;">';
                if (props.name) html += `<div style="font-weight:600;margin-bottom:6px">${props.name}</div>`;
                if (props.hazard_type) html += `<div><strong>ã‚¿ã‚¤ãƒ—:</strong> ${props.hazard_type}</div>`;
                if (props.severity) html += `<div><strong>é‡è¦åº¦:</strong> ${props.severity}</div>`;
                if (props.depth_cm) html += `<div><strong>æµ¸æ°´æ·±(cm):</strong> ${props.depth_cm}</div>`;
                if (props.depth_m) html += `<div><strong>æµ¸æ°´æ·±(m):</strong> ${props.depth_m}</div>`;
                if (props.address) html += `<div><strong>ä½æ‰€:</strong> ${props.address}</div>`;
                if (props.chiban) html += `<div><strong>åœ°ç•ª:</strong> ${props.chiban}</div>`;
                let lat = null, lng = null;
                if (lngLat && lngLat.lng !== undefined) { lat = lngLat.lat; lng = lngLat.lng; }
                else if (props.latitude && props.longitude) { lat = props.latitude; lng = props.longitude; }
                if (lat && lng) html += `<div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">Google ãƒãƒƒãƒ—ã§é–‹ã</a></div>`;
                html += '<div style="margin-top:8px"><button id="detailCloseBtn" class="btn">é–‰ã˜ã‚‹</button></div>';
                html += '</div>';
                el.innerHTML = html;
                const btn = document.getElementById('detailCloseBtn');
                if (btn) btn.addEventListener('click', clearDetail);
            }

            function clearDetail() {
                const el = document.getElementById('detailContent');
                if (!el) return;
                el.innerHTML = 'åœ°å›³ä¸Šã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
            }
        
        // ==========================================
        // ãƒ¬ã‚¤ãƒ¤è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        // ==========================================
        function toggleLayer(layerName) {
            const checkbox = document.getElementById('toggle-' + layerName);
            layersEnabled[layerName] = checkbox.checked;
            
            const layerId = layerName + '-layer';
            const visibility = checkbox.checked ? 'visible' : 'none';
            
            if (map.getLayer(layerId)) {
                map.setLayoutProperty(layerId, 'visibility', visibility);
                
                // ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ãƒ¬ã‚¤ãƒ¤ã‚‚åˆ‡ã‚Šæ›¿ãˆï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                const outlineId = layerName + '-outline';
                if (map.getLayer(outlineId)) {
                    map.setLayoutProperty(outlineId, 'visibility', visibility);
                }
            }
        }
        
        // ==========================================
        // æ¤œç´¢æ©Ÿèƒ½
        // ==========================================
        function searchParcel() {
            if (!cadastralData) {
                addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addStatus('æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'info');
                return;
            }
            
            const results = cadastralData.features.filter(f => {
                const props = f.properties || {};
                const str = JSON.stringify(props).toLowerCase();
                return str.includes(query.toLowerCase());
            });
            
            if (results.length === 0) {
                addStatus('æ¤œç´¢çµæœãªã—', 'error');
                return;
            }
            
            // æœ€åˆã®çµæœã«ã‚ºãƒ¼ãƒ 
            const first = results[0];
            if (first.geometry.type === 'Polygon') {
                const coords = first.geometry.coordinates[0];
                const bounds = coords.reduce((acc, c) => {
                    return {
                        minLng: Math.min(acc.minLng, c[0]),
                        maxLng: Math.max(acc.maxLng, c[0]),
                        minLat: Math.min(acc.minLat, c[1]),
                        maxLat: Math.max(acc.maxLat, c[1])
                    };
                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                
                map.fitBounds([
                    [bounds.minLng, bounds.minLat],
                    [bounds.maxLng, bounds.maxLat]
                ], { padding: 40 });
                
                addStatus(results.length + ' ä»¶ã®æ¤œç´¢çµæœ', 'success');
            }
        }
        
        // ==========================================
        // åˆæœŸåŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
    </script>
</body>
</html>
