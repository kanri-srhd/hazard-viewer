<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ®ÂõΩ„Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„Éó„Éì„É•„Éº„Ç¢ (PMTiles + MapLibre GL)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üó∫Ô∏è</text></svg>">
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    <!-- PMTiles -->
    <script src="https://unpkg.com/pmtiles@3/dist/index.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'MS PGothic', sans-serif;
            background: #f0f0f0;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 15px;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar h1 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-box button {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background: #0b66ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .search-box button:hover {
            background: #0854cc;
        }
        
        .status {
            background: #f9f9f9;
            border-left: 3px solid #0b66ff;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 2px;
            font-size: 12px;
            color: #333;
        }
        
        .status.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        
        .status.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .status.loading {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .status.loading::after {
            content: " ‚è≥";
        }
        
        .layer-controls {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .layer-controls h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .layer-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .info-box {
            background: #f0f8ff;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 12px;
            color: #333;
            line-height: 1.4;
        }
        
        .coord-display {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            font-family: 'Courier New', monospace;
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞„Çπ„Éî„Éä„Éº */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #ddd;
            border-top-color: #0b66ff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="sidebar">
        <h1>üó∫Ô∏è ÂÖ®ÂõΩ„Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„Éó„Éì„É•„Éº„Ç¢</h1>
        
        <div id="statusPanel"></div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Âú∞Áï™ / ‰ΩèÊâÄ„ÅßÊ§úÁ¥¢...">
            <button onclick="searchParcel()">üîç Ê§úÁ¥¢</button>
        </div>
        
        <div class="layer-controls">
            <h3>üìç „É¨„Ç§„É§Ë°®Á§∫</h3>
            <div class="layer-item">
                <input type="checkbox" id="toggle-cadastral" checked onchange="toggleLayer('cadastral')">
                <label for="toggle-cadastral">Âú∞Á±ç (ÈªÑËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-flood" checked onchange="toggleLayer('flood')">
                <label for="toggle-flood">Ê¥™Ê∞¥ (ÈùíËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-landslide" checked onchange="toggleLayer('landslide')">
                <label for="toggle-landslide">ÂúüÁ†ÇÁÅΩÂÆ≥ (Ê©ôËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-tsunami" checked onchange="toggleLayer('tsunami')">
                <label for="toggle-tsunami">Ê¥•Ê≥¢ (Ê∞¥Ëâ≤)</label>
            </div>
        </div>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è ‰ΩøÁî®ÊñπÊ≥ï</strong><br>
            ‚Ä¢ Ê§úÁ¥¢: Âú∞Áï™„Éª‰ΩèÊâÄ„ÅßË©≤ÂΩì„Éù„É™„Ç¥„É≥„ÇíÊ§úÁ¥¢<br>
            ‚Ä¢ „ÉÅ„Çß„ÉÉ„ÇØ: „É¨„Ç§„É§„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà<br>
            ‚Ä¢ „ÇØ„É™„ÉÉ„ÇØ: „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅßË©≥Á¥∞ÊÉÖÂ†±„ÇíË°®Á§∫<br>
            ‚Ä¢ „Ç∫„Éº„É†: „Éû„Ç¶„Çπ„Éõ„Ç§„Éº„É´ or „Éî„É≥„ÉÅ„Ç∫„Éº„É†
        </div>
        
        <div id="coordDisplay" class="coord-display"></div>
    </div>
    
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    
    <!-- PMTiles Library -->
    <script src="https://unpkg.com/pmtiles@3/dist/index.js"></script>
    
    <script>
        // ==========================================
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Éê„Çπ„ÉÜ„Ç£„É≥„Ç∞ & Service Worker „É™„Çª„ÉÉ„Éà
        // ==========================================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(reg => reg.unregister());
            });
        }
        
        // ==========================================
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        // ==========================================
        let map;
        let cadastralData = null;
        let layersEnabled = {
            cadastral: true,
            flood: true,
            landslide: true,
            tsunami: true
        };
        let p; // PMTiles Protocol instance
        
        // ==========================================
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éë„Éç„É´ÁÆ°ÁêÜ
        // ==========================================
        function addStatus(msg, type = 'info') {
            const panel = document.getElementById('statusPanel');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.textContent = msg;
            panel.insertBefore(div, panel.firstChild);
            
            if (type !== 'loading') {
                setTimeout(() => div.style.opacity = '0.7', 2000);
            }
        }
        
        // ==========================================
        // „Éû„ÉÉ„ÉóÂàùÊúüÂåñ
        // ==========================================
        function initMap() {
            addStatus('„Éû„ÉÉ„Éó„ÇíÂàùÊúüÂåñ‰∏≠...', 'loading');
            
            // MapLibre GL ‰∫íÊèõ„Çπ„Çø„Ç§„É´ÔºàCORS „Éï„É™„ÉºÔºâ
            const style = {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [
                    {
                        id: 'osm',
                        type: 'raster',
                        source: 'osm'
                    }
                ]
            };
            
            map = new maplibregl.Map({
                container: 'map',
                style: style,
                center: [136.5, 35.5], // Êó•Êú¨‰∏≠Â§ÆÔºàÊÑõÁü•ÁúåÔºâ
                zoom: 5,
                pitch: 0,
                bearing: 0
            });
            
            map.on('load', () => {
                addStatus('„Éû„ÉÉ„ÉóË™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                // PMTiles „ÅÆ„É≠„Éº„Éâ„ÇíÂ∞ë„ÅóÈÅÖÂª∂„Åï„Åõ„ÇãÔºà„É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§Ôºâ
                setTimeout(() => {
                    initPMTiles();
                    setupEventHandlers();
                }, 500);
            });
            
            map.on('error', (err) => {
                console.error('Map error:', err);
                addStatus('„Éû„ÉÉ„Éó„Ç®„É©„Éº: ' + err.error, 'error');
            });
        }
        
        // ==========================================
        // PMTiles „Éó„É≠„Éà„Ç≥„É´ÂàùÊúüÂåñ
        // ==========================================
        function initPMTiles() {
            addStatus('PMTiles „Éó„É≠„Éà„Ç≥„É´„ÇíÂàùÊúüÂåñ‰∏≠...', 'loading');
            
            // PMTiles „É©„Ç§„Éñ„É©„É™„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
            if (typeof pmtiles === 'undefined' || !pmtiles.Protocol) {
                console.warn('PMTiles library not yet loaded, using GeoJSON fallback');
                addStatus('PMTiles „É©„Ç§„Éñ„É©„É™Êú™Ë™≠„ÅøËæº„Åø ‚Üí GeoJSON „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ', 'info');
                loadGeoJSONFallback();
                return;
            }
            
            try {
                // PMTiles Protocol „ÇíÁôªÈå≤
                p = new pmtiles.Protocol();
                maplibregl.addProtocol('pmtiles', p.tile);
                
                addStatus('PMTiles „Éó„É≠„Éà„Ç≥„É´ÁôªÈå≤ÊàêÂäü', 'success');
                
                // „É¨„Ç§„É§„Çí„É≠„Éº„Éâ
                loadPMTilesLayers();
            } catch (err) {
                console.error('PMTiles Protocol Error:', err);
                addStatus('PMTiles „Éó„É≠„Éà„Ç≥„É´ÁôªÈå≤Â§±Êïó: ' + err.message, 'error');
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: GeoJSON „Çí‰ΩøÁî®
                loadGeoJSONFallback();
            }
        }
        
        // ==========================================
        // PMTiles „É¨„Ç§„É§„ÅÆ„É≠„Éº„ÉâÔºàMapLibre GL „Éç„Ç§„ÉÜ„Ç£„ÉñÔºâ
        // ==========================================
        function loadPMTilesLayers() {
            // Âú∞Á±ç PMTiles
            addStatus('Âú∞Á±ç PMTiles „ÇíË™≠„ÅøËæº„Åø‰∏≠...', 'loading');
            
            // PMTiles URL „Çπ„Ç≠„Éº„É†ÔºàGitHub Pages Áí∞Â¢ÉÂØæÂøúÔºâ
            const baseUrl = window.location.pathname.includes('/docs/') 
                ? '/hazard-viewer/docs/data/'
                : './data/';
            const cadastralUrl = 'pmtiles://' + window.location.origin + baseUrl + 'cadastral_national.pmtiles';
            
            try {
                // Âú∞Á±ç„É¨„Ç§„É§Ôºà„Éù„É™„Ç¥„É≥Ôºâ
                map.addSource('cadastral-source', {
                    type: 'vector',
                    url: cadastralUrl
                });
                
                map.addLayer({
                    id: 'cadastral-layer',
                    type: 'fill',
                    source: 'cadastral-source',
                    'source-layer': 'cadastral',
                    paint: {
                        'fill-color': '#ffcc00',
                        'fill-opacity': 0.4,
                        'fill-outline-color': '#333'
                    }
                });
                
                map.addLayer({
                    id: 'cadastral-outline',
                    type: 'line',
                    source: 'cadastral-source',
                    'source-layer': 'cadastral',
                    paint: {
                        'line-color': '#333',
                        'line-width': 1
                    }
                });
                
                addStatus('Âú∞Á±ç„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                
                // „Éè„Ç∂„Éº„Éâ PMTiles „Çí„É≠„Éº„Éâ
                loadHazardPMTiles();
                
            } catch (err) {
                console.error('Cadastral layer error:', err);
                addStatus('Âú∞Á±ç„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ' + err.message, 'error');
            }
        }
        
        // ==========================================
        // „Éè„Ç∂„Éº„Éâ PMTiles „ÅÆ„É≠„Éº„Éâ
        // ==========================================
        function loadHazardPMTiles() {
            const baseUrl = window.location.pathname.includes('/docs/') 
                ? '/hazard-viewer/docs/data/'
                : './data/';
            const hazardUrl = 'pmtiles://' + window.location.origin + baseUrl + 'hazard_integrated_national.pmtiles';
            
            // Ê¥™Ê∞¥
            try {
                map.addSource('flood-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'flood-layer',
                    type: 'fill',
                    source: 'flood-source',
                    'source-layer': 'flood',
                    paint: {
                        'fill-color': '#0b66ff',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('Ê¥™Ê∞¥„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
            } catch (err) {
                console.warn('Flood layer error:', err);
            }
            
            // ÂúüÁ†ÇÁÅΩÂÆ≥
            try {
                map.addSource('landslide-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'landslide-layer',
                    type: 'fill',
                    source: 'landslide-source',
                    'source-layer': 'landslide',
                    paint: {
                        'fill-color': '#ff8c00',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('ÂúüÁ†ÇÁÅΩÂÆ≥„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
            } catch (err) {
                console.warn('Landslide layer error:', err);
            }
            
            // Ê¥•Ê≥¢
            try {
                map.addSource('tsunami-source', {
                    type: 'vector',
                    url: hazardUrl
                });
                
                map.addLayer({
                    id: 'tsunami-layer',
                    type: 'fill',
                    source: 'tsunami-source',
                    'source-layer': 'tsunami',
                    paint: {
                        'fill-color': '#00c8d8',
                        'fill-opacity': 0.3
                    }
                });
                
                addStatus('Ê¥•Ê≥¢„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
            } catch (err) {
                console.warn('Tsunami layer error:', err);
            }
        }
        
        // ==========================================
        // GeoJSON „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàPMTiles Êú™ÂØæÂøúÁí∞Â¢ÉÔºâ
        // ==========================================
        function loadGeoJSONFallback() {
            addStatus('GeoJSON „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„É¢„Éº„Éâ„ÅßÂÆüË°å', 'info');
            
            // Âú∞Á±ç GeoJSON „Çí„É≠„Éº„Éâ
            addStatus('Âú∞Á±ç GeoJSON „ÇíË™≠„ÅøËæº„Åø‰∏≠...', 'loading');
            fetch('../geojson/27128__6_r_2024.geojson')
                .then(r => r.json())
                .then(geojson => {
                    cadastralData = geojson;
                    
                    map.addSource('cadastral-source', {
                        type: 'geojson',
                        data: geojson
                    });
                    
                    map.addLayer({
                        id: 'cadastral-layer',
                        type: 'fill',
                        source: 'cadastral-source',
                        paint: {
                            'fill-color': '#ffcc00',
                            'fill-opacity': 0.4,
                            'fill-outline-color': '#333'
                        }
                    });
                    
                    map.addLayer({
                        id: 'cadastral-outline',
                        type: 'line',
                        source: 'cadastral-source',
                        paint: {
                            'line-color': '#333',
                            'line-width': 1
                        }
                    });
                    
                    addStatus('Âú∞Á±ç GeoJSON Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü (' + geojson.features.length + ' ‰ª∂)', 'success');
                    
                    // „Éè„Ç∂„Éº„Éâ GeoJSON „Çí„É≠„Éº„Éâ
                    loadHazardGeoJSON();
                })
                .catch(err => {
                    console.error('GeoJSON load error:', err);
                    addStatus('GeoJSON Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº', 'error');
                });
        }
        
        // ==========================================
        // „Éè„Ç∂„Éº„Éâ GeoJSON „ÅÆ„É≠„Éº„ÉâÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
        // ==========================================
        function loadHazardGeoJSON() {
            // Ê¥™Ê∞¥
            fetch('../geojson/hazard_sample_flood_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('flood-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'flood-layer',
                        type: 'fill',
                        source: 'flood-source',
                        paint: { 'fill-color': '#0b66ff', 'fill-opacity': 0.3 }
                    });
                    addStatus('Ê¥™Ê∞¥„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                })
                .catch(err => console.warn('Flood GeoJSON error:', err));
            
            // ÂúüÁ†ÇÁÅΩÂÆ≥
            fetch('../geojson/hazard_sample_landslide_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('landslide-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'landslide-layer',
                        type: 'fill',
                        source: 'landslide-source',
                        paint: { 'fill-color': '#ff8c00', 'fill-opacity': 0.3 }
                    });
                    addStatus('ÂúüÁ†ÇÁÅΩÂÆ≥„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                })
                .catch(err => console.warn('Landslide GeoJSON error:', err));
            
            // Ê¥•Ê≥¢
            fetch('../geojson/hazard_sample_tsunami_osaka.geojson')
                .then(r => r.json())
                .then(gj => {
                    map.addSource('tsunami-source', { type: 'geojson', data: gj });
                    map.addLayer({
                        id: 'tsunami-layer',
                        type: 'fill',
                        source: 'tsunami-source',
                        paint: { 'fill-color': '#00c8d8', 'fill-opacity': 0.3 }
                    });
                    addStatus('Ê¥•Ê≥¢„É¨„Ç§„É§Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                })
                .catch(err => console.warn('Tsunami GeoJSON error:', err));
        }
        
        // ==========================================
        // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
        // ==========================================
        function setupEventHandlers() {
            // „Ç∫„Éº„É†„Éª„Éë„É≥ÊôÇ„Å´Â∫ßÊ®ô„ÇíÊõ¥Êñ∞
            map.on('mousemove', (e) => {
                const zoom = map.getZoom().toFixed(2);
                const lat = e.lngLat.lat.toFixed(4);
                const lng = e.lngLat.lng.toFixed(4);
                document.getElementById('coordDisplay').textContent = 
                    `üéØ Zoom: ${zoom} | Lat: ${lat} | Lng: ${lng}`;
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åß„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫ÔºàPMTiles „ÅÆÂ†¥Âêà„ÄÅ„Éï„Ç£„Éº„ÉÅ„É£„Çí„ÇØ„Ç®„É™Ôºâ
            map.on('click', 'cadastral-layer', (e) => {
                const features = map.querySourceFeatures('cadastral-source', {
                    sourceLayer: 'cadastral'
                });
                if (features.length > 0) {
                    const feature = features[0];
                    const props = feature.properties || {};
                    let popupHtml = '<div style="font-size:12px;"><strong>Âú∞Á±ç</strong><br>';
                    for (let key in props) {
                        popupHtml += `<strong>${key}</strong>: ${props[key]}<br>`;
                    }
                    popupHtml += '</div>';
                    
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(popupHtml)
                        .addTo(map);
                }
            });
            
            map.on('click', 'flood-layer', (e) => {
                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML('<strong>Ê¥™Ê∞¥„É™„Çπ„ÇØ„Ç®„É™„Ç¢</strong>')
                    .addTo(map);
            });
        }
        
        // ==========================================
        // „É¨„Ç§„É§Ë°®Á§∫Âàá„ÇäÊõø„Åà
        // ==========================================
        function toggleLayer(layerName) {
            const checkbox = document.getElementById('toggle-' + layerName);
            layersEnabled[layerName] = checkbox.checked;
            
            const layerId = layerName + '-layer';
            const visibility = checkbox.checked ? 'visible' : 'none';
            
            if (map.getLayer(layerId)) {
                map.setLayoutProperty(layerId, 'visibility', visibility);
                
                // „Ç¢„Ç¶„Éà„É©„Ç§„É≥„É¨„Ç§„É§„ÇÇÂàá„ÇäÊõø„ÅàÔºàÂ≠òÂú®„Åô„ÇãÂ†¥ÂêàÔºâ
                const outlineId = layerName + '-outline';
                if (map.getLayer(outlineId)) {
                    map.setLayoutProperty(outlineId, 'visibility', visibility);
                }
            }
        }
        
        // ==========================================
        // Ê§úÁ¥¢Ê©üËÉΩ
        // ==========================================
        function searchParcel() {
            if (!cadastralData) {
                addStatus('Âú∞Á±ç„Éá„Éº„Çø„Åå„Åæ„Å†Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', 'error');
                return;
            }
            
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addStatus('Ê§úÁ¥¢Ë™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'info');
                return;
            }
            
            const results = cadastralData.features.filter(f => {
                const props = f.properties || {};
                const str = JSON.stringify(props).toLowerCase();
                return str.includes(query.toLowerCase());
            });
            
            if (results.length === 0) {
                addStatus('Ê§úÁ¥¢ÁµêÊûú„Å™„Åó', 'error');
                return;
            }
            
            // ÊúÄÂàù„ÅÆÁµêÊûú„Å´„Ç∫„Éº„É†
            const first = results[0];
            if (first.geometry.type === 'Polygon') {
                const coords = first.geometry.coordinates[0];
                const bounds = coords.reduce((acc, c) => {
                    return {
                        minLng: Math.min(acc.minLng, c[0]),
                        maxLng: Math.max(acc.maxLng, c[0]),
                        minLat: Math.min(acc.minLat, c[1]),
                        maxLat: Math.max(acc.maxLat, c[1])
                    };
                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                
                map.fitBounds([
                    [bounds.minLng, bounds.minLat],
                    [bounds.maxLng, bounds.maxLat]
                ], { padding: 40 });
                
                addStatus(results.length + ' ‰ª∂„ÅÆÊ§úÁ¥¢ÁµêÊûú', 'success');
            }
        }
        
        // ==========================================
        // ÂàùÊúüÂåñ
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
    </script>
</body>
</html>
