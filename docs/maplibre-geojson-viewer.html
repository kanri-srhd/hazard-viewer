<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å›½ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢ (GeoJSON + MapLibre GL)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>ğŸ—ºï¸</text></svg>">
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'MS PGothic', sans-serif;
            background: #f0f0f0;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 15px;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar h1 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .search-box button {
            width: 100%;
            padding: 8px;
            background: #0b66ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .search-box button:hover {
            background: #0854cc;
        }
        
        .status {
            background: #f9f9f9;
            border-left: 3px solid #0b66ff;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 2px;
            font-size: 11px;
            color: #333;
        }
        
        .status.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        
        .status.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .status.loading {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .layer-controls {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 12px;
        }
        
        .layer-controls h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .layer-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .info-box {
            background: #f0f8ff;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        .detail-panel {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #222;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="sidebar">
        <h1>ğŸ—ºï¸ MapLibre GLç‰ˆ ãƒã‚¶ãƒ¼ãƒ‰ãƒãƒƒãƒ—ãƒ“ãƒ¥ãƒ¼ã‚¢</h1>
        
        <div id="statusPanel" style="max-height: 100px; overflow-y: auto;"></div>
        <div id="diagPanel" style="margin-top:8px;padding:8px;background:#fff;border:1px solid #eee;border-radius:4px;font-size:12px;">
            <strong>è¨ºæ–­ãƒ‘ãƒãƒ«</strong>
            <div id="diagContent" style="margin-top:6px;color:#333;">ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿çŠ¶æ³ã‚’ã“ã“ã«è¡¨ç¤ºã—ã¾ã™ã€‚</div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="åœ°ç•ª / ä½æ‰€ / GoogleMapURL ã§æ¤œç´¢...">
            <button onclick="searchParcel()">ğŸ” æ¤œç´¢</button>
            <button onclick="openChibanSearch()" style="margin-top:5px;background:#ff6b6b;width:100%;">ğŸ›ï¸ åœ°ç•ªæ¤œç´¢ã‚’é–‹ã</button>
        </div>
        
        <div class="layer-controls">
            <h3>ğŸ“ ãƒ¬ã‚¤ãƒ¤è¡¨ç¤º</h3>
            <div class="layer-item">
                <input type="checkbox" id="toggle-cadastral" checked onchange="toggleLayer('cadastral')">
                <label for="toggle-cadastral">åœ°ç± (é»„è‰²)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-flood" checked onchange="toggleLayer('flood')">
                <label for="toggle-flood">æ´ªæ°´ (é’è‰²)</label>
                <button onclick="exportPDF('flood', '01_æ´ªæ°´ãƒã‚¶ãƒ¼ãƒ‰')" style="margin-left:auto;padding:4px 8px;font-size:11px;background:#0b66ff;color:white;border:none;border-radius:3px;cursor:pointer;">PDF</button>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-landslide" checked onchange="toggleLayer('landslide')">
                <label for="toggle-landslide">åœŸç ‚ç½å®³ (æ©™è‰²)</label>
                <button onclick="exportPDF('landslide', '02_åœŸç ‚ç½å®³')" style="margin-left:auto;padding:4px 8px;font-size:11px;background:#ff8c00;color:white;border:none;border-radius:3px;cursor:pointer;">PDF</button>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-tsunami" checked onchange="toggleLayer('tsunami')">
                <label for="toggle-tsunami">æ´¥æ³¢ (æ°´è‰²)</label>
                <button onclick="exportPDF('tsunami', '04_æ´¥æ³¢ãƒã‚¶ãƒ¼ãƒ‰')" style="margin-left:auto;padding:4px 8px;font-size:11px;background:#00c8d8;color:white;border:none;border-radius:3px;cursor:pointer;">PDF</button>
            </div>
        </div>
        
        <div class="info-box">
            <strong>â„¹ï¸ ä½¿ç”¨æ–¹æ³•</strong><br>
            â€¢ æ¤œç´¢ã§è©²å½“ãƒãƒªã‚´ãƒ³ã‚’æ¤œç´¢<br>
            â€¢ ãƒã‚§ãƒƒã‚¯ã§ãƒ¬ã‚¤ãƒ¤åˆ‡ã‚Šæ›¿ãˆ<br>
            â€¢ ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°æƒ…å ±è¡¨ç¤º
            <div style="margin-top:8px;">
                <button id="toggleGuideBtn" onclick="toggleGuide()" style="padding:6px 12px;background:#4CAF50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;width:100%;">ğŸ“‹ å‡ºåŠ›ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º</button>
            </div>
        </div>
        
        <div id="guidePanel" style="display:none;background:#fffacd;border:1px solid #f0ad4e;border-radius:4px;padding:10px;margin-top:10px;font-size:12px;color:#333;line-height:1.6;">
            <strong>ğŸ“ PDFå‡ºåŠ›æ‰‹é †</strong><br><br>
            <strong>1ï¸âƒ£ åœ°ç•ªç¢ºèª</strong><br>
            ã€ŒğŸ›ï¸ åœ°ç•ªæ¤œç´¢ã‚’é–‹ãã€ â†’ æ³•å‹™çœã‚µãƒ¼ãƒ“ã‚¹ã§åœ°ç•ªç¢ºèª â†’ Ctrl+P ã§ PDFä¿å­˜<br>
            ãƒ•ã‚¡ã‚¤ãƒ«å: <code>11_åœ°ç•ª_[éƒ½é“åºœçœŒå¸‚åŒºç”ºæ‘å­—åœ°ç•ª].pdf</code><br><br>
            <strong>2ï¸âƒ£ ãƒã‚¶ãƒ¼ãƒ‰ç¢ºèª</strong><br>
            å„ãƒã‚¶ãƒ¼ãƒ‰ã® ã€PDFã€‘ ãƒœã‚¿ãƒ³ â†’ åœ°å›³ãŒ PDFåŒ–ã•ã‚Œã¾ã™<br>
            â€¢ 01_æ´ªæ°´ãƒã‚¶ãƒ¼ãƒ‰_....pdf<br>
            â€¢ 02_åœŸç ‚ç½å®³_....pdf<br>
            â€¢ 04_æ´¥æ³¢ãƒã‚¶ãƒ¼ãƒ‰_....pdf<br>
            â€¢ 05_æ¶²çŠ¶åŒ–ãƒã‚¶ãƒ¼ãƒ‰_....pdf<br><br>
            <strong>3ï¸âƒ£ ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</strong><br>
            ã™ã¹ã¦ã®PDFã‚’ Google Drive ã®å€™è£œåœ°ãƒ•ã‚©ãƒ«ãƒ€ã¸ä¿å­˜ â†’ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã« URL ã‚’è¨˜è¼‰<br><br>
            <strong>âš ï¸ æ³¨æ„</strong><br>
            â€¢ æœªæä¾›ã‚¨ãƒªã‚¢ã¯ã€Œæ³•å‹™å±€çª“å£ã§ç¢ºèªã€ã¨æ˜è¨˜<br>
            â€¢ å‡ºå…¸è¡¨ç¤ºï¼ˆå›½åœŸäº¤é€šçœç­‰ï¼‰ã‚’ PDFå†…ã«è¨˜è¼‰
        </div>
        <div id="detailPanel" class="detail-panel">
            <strong>è©³ç´°æƒ…å ±</strong>
            <div id="detailContent" style="margin-top:8px;font-size:13px;color:#333;">åœ°å›³ä¸Šã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        </div>
    </div>
    
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    
    <!-- html2canvas & jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // ==========================================
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ==========================================
        let map;
        let cadastralData = null;
        let layerVisibility = { cadastral: true, flood: true, landslide: true, tsunami: true };
        
        function addStatus(msg, type = 'info') {
            const panel = document.getElementById('statusPanel');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.textContent = msg;
            panel.insertBefore(div, panel.firstChild);
            if (panel.children.length > 5) {
                panel.removeChild(panel.lastChild);
            }
        }
        
        // ==========================================
        // ãƒãƒƒãƒ—åˆæœŸåŒ–
        // ==========================================
        function initMap() {
            addStatus('ãƒãƒƒãƒ—åˆæœŸåŒ–ä¸­...', 'loading');
            
            const style = {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap'
                    }
                },
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
            };
            
            map = new maplibregl.Map({
                container: 'map',
                style: style,
                center: [135.5, 34.69],
                zoom: 6
            });
            
            map.on('load', () => {
                addStatus('ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                loadGeoJSONData();
                
                // Clear detail and popups when clicking outside features
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['cadastral-layer','flood-layer','landslide-layer','tsunami-layer'] });
                    if (!features || features.length === 0) {
                        clearDetail();
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                    }
                });
            });
            
            map.on('error', (err) => {
                console.error('Map error:', err);
                addStatus('ãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼', 'error');
            });
        }
        
        // ==========================================
        // GeoJSON ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ==========================================
        function loadGeoJSONData() {
            addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...', 'loading');
            
            fetch('../geojson/27128__6_r_2024.geojson')
                .then(r => r.json())
                .then(geojson => {
                    cadastralData = geojson;
                    
                    map.addSource('cadastral-source', { type: 'geojson', data: geojson });
                    map.addLayer({
                        id: 'cadastral-layer',
                        type: 'fill',
                        source: 'cadastral-source',
                        paint: {
                            'fill-color': '#ffcc00',
                            'fill-opacity': 0.4,
                            'fill-outline-color': '#333'
                        }
                    });
                    // cadastral hover / click handling
                    let cadastralHover = null;
                    map.on('mousemove', 'cadastral-layer', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        if (window.__pinnedPopup) return;
                        const props = (e.features && e.features[0] && e.features[0].properties) || {};
                        const brief = formatPropsBrief(props);
                        if (cadastralHover) cadastralHover.remove();
                        cadastralHover = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(brief)
                            .addTo(map);
                    });
                    map.on('mouseleave', 'cadastral-layer', () => {
                        map.getCanvas().style.cursor = '';
                        if (cadastralHover) { cadastralHover.remove(); cadastralHover = null; }
                    });
                    map.on('click', 'cadastral-layer', (e) => {
                        const props = (e.features && e.features[0] && e.features[0].properties) || {};
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                        window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(formatPropsLong(props))
                            .addTo(map);
                        // zoom to parcel
                        try {
                            const geom = e.features[0].geometry;
                            if (geom && geom.type === 'Polygon') {
                                const coords = geom.coordinates[0];
                                const bounds = coords.reduce((acc, c) => {
                                    return {
                                        minLng: Math.min(acc.minLng, c[0]),
                                        maxLng: Math.max(acc.maxLng, c[0]),
                                        minLat: Math.min(acc.minLat, c[1]),
                                        maxLat: Math.max(acc.maxLat, c[1])
                                    };
                                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                                map.fitBounds([[bounds.minLng, bounds.minLat], [bounds.maxLng, bounds.maxLat]], { padding: 20 });
                            }
                        } catch (err) {}
                        showDetail(props, e.lngLat);
                    });
                    
                    addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† (' + geojson.features.length + ' ä»¶)', 'success');
                    loadHazardData();
                })
                .catch(err => {
                    console.error('Cadastral load error:', err);
                    addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                });
        }
        
        // ==========================================
        // ãƒã‚¶ãƒ¼ãƒ‰ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        // ==========================================
        function loadHazardData() {
            const hazards = [
                { id: 'flood', url: '../geojson/hazard_sample_flood_osaka.geojson', label: 'æ´ªæ°´', color: '#0b66ff' },
                { id: 'landslide', url: '../geojson/hazard_sample_landslide_osaka.geojson', label: 'åœŸç ‚ç½å®³', color: '#ff8c00' },
                { id: 'tsunami', url: '../geojson/hazard_sample_tsunami_osaka.geojson', label: 'æ´¥æ³¢', color: '#00c8d8' }
            ];
            
            hazards.forEach(h => {
                fetch(h.url)
                    .then(r => r.json())
                    .then(geojson => {
                        map.addSource(h.id + '-source', { type: 'geojson', data: geojson });
                        map.addLayer({
                            id: h.id + '-layer',
                            type: 'fill',
                            source: h.id + '-source',
                            paint: {
                                'fill-color': h.color,
                                'fill-opacity': 0.3,
                                'fill-outline-color': h.color
                            }
                        });
                        
                            // hover popup / click detail handling
                            // hoverPopup: temporary hover popup, pinnedPopup: click-pinned popup
                            let hoverPopup = null;
                            // mousemove: show brief popup
                        map.on('mousemove', h.id + '-layer', (e) => {
                            map.getCanvas().style.cursor = 'pointer';
                            if (window.__pinnedPopup) return;
                            const props = (e.features && e.features[0] && e.features[0].properties) || {};
                            const brief = formatPropsBrief(props);
                            if (hoverPopup) hoverPopup.remove();
                            hoverPopup = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                                .setLngLat(e.lngLat)
                                .setHTML(brief)
                                .addTo(map);
                        });                            map.on('mouseleave', h.id + '-layer', () => {
                                map.getCanvas().style.cursor = '';
                                if (hoverPopup) {
                                    hoverPopup.remove();
                                    hoverPopup = null;
                                }
                            });

                            // click: pinned popup + detail panel
                            map.on('click', h.id + '-layer', (e) => {
                                const props = (e.features && e.features[0] && e.features[0].properties) || {};
                                // remove any existing pinned popup
                                if (window.__pinnedPopup) {
                                    try { window.__pinnedPopup.remove(); } catch (e) {}
                                    window.__pinnedPopup = null;
                                }
                                window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                                    .setLngLat(e.lngLat)
                                    .setHTML(formatPropsLong(props))
                                    .addTo(map);
                                showDetail(props, e.lngLat);
                            });
                        addStatus(h.label + ' èª­ã¿è¾¼ã¿å®Œäº†', 'success');
                    })
                    .catch(err => {
                        console.warn(h.label + ' load error:', err);
                        addStatus(h.label + ' èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                    });
            });
        }
        
        // ==========================================
        // Utilities for detail display
        function formatPropsBrief(props) {
            if (!props) return '<div>æƒ…å ±ãªã—</div>';
            const name = props.name || props.chiban || props.address || props.block || '';
            return `<div style="font-size:12px;"><strong>${name}</strong></div>`;
        }

        function formatPropsLong(props) {
            if (!props) return '<div>æƒ…å ±ãªã—</div>';
            let html = '<div style="font-size:13px;line-height:1.4;">';
            const keys = Object.keys(props);
            keys.forEach(k => {
                const v = props[k];
                if (v === null || v === undefined || v === '') return;
                html += `<div><strong>${k}</strong>: ${String(v)}</div>`;
            });
            html += '</div>';
            return html;
        }

        function showDetail(props, lngLat) {
            const el = document.getElementById('detailContent');
            if (!el) return;
            let html = '<div style="font-size:13px;">';
            if (props.name) html += `<div style="font-weight:600;margin-bottom:6px">${props.name}</div>`;
            if (props.hazard_type) html += `<div><strong>ã‚¿ã‚¤ãƒ—:</strong> ${props.hazard_type}</div>`;
            if (props.severity) html += `<div><strong>é‡è¦åº¦:</strong> ${props.severity}</div>`;
            if (props.depth_cm) html += `<div><strong>æµ¸æ°´æ·±(cm):</strong> ${props.depth_cm}</div>`;
            if (props.depth_m) html += `<div><strong>æµ¸æ°´æ·±(m):</strong> ${props.depth_m}</div>`;
            if (props.address) html += `<div><strong>ä½æ‰€:</strong> ${props.address}</div>`;
            if (props.chiban) html += `<div><strong>åœ°ç•ª:</strong> ${props.chiban}</div>`;
            // google maps link (try to compute centroid if lngLat not provided)
            let lat = null, lng = null;
            if (lngLat && lngLat.lng !== undefined) { lat = lngLat.lat; lng = lngLat.lng; }
            else if (props.latitude && props.longitude) { lat = props.latitude; lng = props.longitude; }
            if (!lat && props.geometry) {
                try {
                    const geom = props.geometry;
                    // if geometry contains coordinates
                } catch (e) {}
            }
            if (lat && lng) {
                html += `<div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">Google ãƒãƒƒãƒ—ã§é–‹ã</a></div>`;
            }
            html += '<div style="margin-top:8px"><button id="detailCloseBtn" class="btn">é–‰ã˜ã‚‹</button></div>';
            html += '</div>';
            el.innerHTML = html;
            const btn = document.getElementById('detailCloseBtn');
            if (btn) btn.addEventListener('click', clearDetail);
        }

        function clearDetail() {
            const el = document.getElementById('detailContent');
            if (!el) return;
            el.innerHTML = 'åœ°å›³ä¸Šã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã“ã“ã«è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        }
        function toggleLayer(name) {
            const checkbox = document.getElementById('toggle-' + name);
            const visibility = checkbox.checked ? 'visible' : 'none';
            
            if (map.getLayer(name + '-layer')) {
                map.setLayoutProperty(name + '-layer', 'visibility', visibility);
            }
        }
        
        // ==========================================
        // GoogleMap URL ãƒ‘ãƒ¼ã‚¹é–¢æ•°
        // ==========================================
        function parseGoogleMapURL(input) {
            // GoogleMap URL ãƒ‘ã‚¿ãƒ¼ãƒ³: https://www.google.com/maps/search/.../@lat,lng,zoom
            const urlPattern = /@(-?\d+\.?\d*),(-?\d+\.?\d*)/;
            const match = input.match(urlPattern);
            if (match) {
                return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
            }
            
            // åº§æ¨™ãƒ‘ã‚¿ãƒ¼ãƒ³: "lat,lng" ã¾ãŸã¯ "lat lng"
            const coordPattern = /(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/;
            const coordMatch = input.match(coordPattern);
            if (coordMatch) {
                return { lat: parseFloat(coordMatch[1]), lng: parseFloat(coordMatch[2]) };
            }
            
            return null;
        }
        
        // ==========================================
        // åœ°ç•ªæ¤œç´¢ã‚’é–‹ãï¼ˆæ³•å‹™çœã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒªãƒ³ã‚¯ã‚¢ã‚¦ãƒˆï¼‰
        // ==========================================
        function openChibanSearch() {
            const url = 'https://www1.touki.or.jp/';
            window.open(url, '_blank');
            addStatus('æ³•å‹™çœåœ°ç•ªæ¤œç´¢ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ–°è¦ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸã€‚', 'info');
            addStatus('ğŸ“ ã‚¬ã‚¤ãƒ‰: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€çµæœç”»é¢ã§ Ctrl+P (Cmd+P) â†’ PDFä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'info');
        }
        
        // ==========================================
        // PDFå‡ºåŠ›é–¢æ•°ï¼ˆhtml2canvas + jsPDFï¼‰
        // ==========================================
        async function exportPDF(hazardType, pdfFileName) {
            addStatus('ğŸ“„ PDFç”Ÿæˆä¸­...', 'loading');
            
            try {
                // ãƒãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
                const mapElement = document.getElementById('map');
                const canvas = await html2canvas(mapElement, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                
                // PDFåŒ–
                const imgData = canvas.toDataURL('image/png');
                // jsPDF ã® UMD ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«ã¯å¤‰ç¨®ãŒã‚ã‚‹ãŸã‚å®‰å…¨ã«æ¤œå‡ºã™ã‚‹
                let pdf;
                const opts = { orientation: 'landscape', unit: 'mm', format: 'a4' };
                if (window.jspdf && window.jspdf.jsPDF) {
                    pdf = new window.jspdf.jsPDF(opts);
                } else if (typeof window.jsPDF === 'function') {
                    // ä¸€éƒ¨ãƒãƒ³ãƒ‰ãƒ«ã¯ç›´æ¥ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ window.jsPDF ã«å‰²ã‚Šå½“ã¦ã‚‹
                    pdf = new window.jsPDF(opts);
                } else if (window.jsPDF && window.jsPDF.jsPDF) {
                    pdf = new window.jsPDF.jsPDF(opts);
                } else {
                    throw new Error('jsPDF ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
                // ç”»åƒã‚’ PDF ã«è¿½åŠ 
                const imgWidth = 297; // A4 æ¨ªå¹…
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                // å‡ºå…¸ã¨æ³¨è¨˜ã‚’è¿½åŠ 
                pdf.setFontSize(8);
                pdf.text('å‡ºå…¸: å›½åœŸäº¤é€šçœ é‡ã­ã‚‹ãƒã‚¶ãƒ¼ãƒ‰åœ°å›³', 10, 210);
                pdf.text('â€» æœªæä¾›ã‚¨ãƒªã‚¢ã¯æ³•å‹™å±€çª“å£ã§ç¢ºèªã—ã¦ãã ã•ã„', 10, 215);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆï¼ˆç¾åœ¨ã®åœ°ç•ªæƒ…å ±ã‚’è¿½åŠ ï¼‰
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                const filename = `${pdfFileName}_${timestamp}.pdf`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                pdf.save(filename);
                addStatus(`âœ… PDFä¿å­˜å®Œäº†: ${filename}`, 'success');
                
            } catch (err) {
                console.error('PDF export error:', err);
                addStatus('âŒ PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
            }
        }
        
        // ==========================================
        // å‡ºåŠ›ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºãƒˆã‚°ãƒ«
        // ==========================================
        function toggleGuide() {
            const guidePanel = document.getElementById('guidePanel');
            const btn = document.getElementById('toggleGuideBtn');
            if (guidePanel.style.display === 'none') {
                guidePanel.style.display = 'block';
                btn.textContent = 'ğŸ“‹ å‡ºåŠ›ã‚¬ã‚¤ãƒ‰ã‚’éè¡¨ç¤º';
            } else {
                guidePanel.style.display = 'none';
                btn.textContent = 'ğŸ“‹ å‡ºåŠ›ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º';
            }
        }

        // ==========================================
        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨ºæ–­: html2canvas / jsPDF ã®æœ‰ç„¡ã‚’ãƒã‚§ãƒƒã‚¯
        // ==========================================
        function checkLibraries() {
            const diag = document.getElementById('diagContent');
            const hasHtml2 = typeof window.html2canvas === 'function' || typeof window.html2canvas === 'object' || !!window.html2canvas;
            const hasJSPDF = !!( (window.jspdf && window.jspdf.jsPDF) || (typeof window.jsPDF === 'function') || (window.jsPDF && window.jsPDF.jsPDF) );
            let html = '';
            html += `<div>html2canvas: <strong style="color:${hasHtml2?"#0b6623":"#d64444"}">${hasHtml2?"èª­ã¿è¾¼ã¿æ¸ˆã¿":"æœªèª­ã¿è¾¼ã¿"}</strong></div>`;
            html += `<div>jsPDF: <strong style="color:${hasJSPDF?"#0b6623":"#d64444"}">${hasJSPDF?"èª­ã¿è¾¼ã¿æ¸ˆã¿":"æœªèª­ã¿è¾¼ã¿"}</strong></div>`;
            diag.innerHTML = html;

            // ç„¡ã‘ã‚Œã° PDF ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const pdfButtons = document.querySelectorAll('button[onclick^="exportPDF("]');
            pdfButtons.forEach(b => {
                if (!hasHtml2 || !hasJSPDF) {
                    b.disabled = true;
                    b.style.opacity = '0.5';
                    b.title = 'PDF ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæœªèª­ã¿è¾¼ã¿ã®ãŸã‚ç„¡åŠ¹ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                } else {
                    b.disabled = false;
                    b.style.opacity = '';
                    b.title = '';
                }
            });
            return { hasHtml2, hasJSPDF };
        }
        
        // ==========================================
        // æ¤œç´¢æ©Ÿèƒ½ï¼ˆGoogleMapURLãƒ»åº§æ¨™ãƒ‘ãƒ¼ã‚¹å¯¾å¿œï¼‰
        // ==========================================
        function searchParcel() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addStatus('æ¤œç´¢èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // GoogleMapURL ã¾ãŸã¯åº§æ¨™ã®ãƒ‘ãƒ¼ã‚¹è©¦è¡Œ
            const coords = parseGoogleMapURL(query);
            if (coords) {
                map.flyTo({ center: [coords.lng, coords.lat], zoom: 14 });
                addStatus(`ğŸ“ åº§æ¨™: ${coords.lat.toFixed(4)}, ${coords.lng.toFixed(4)} ã¸ç§»å‹•`, 'success');
                return;
            }
            
            // é€šå¸¸ã®åœ°ç•ªãƒ»ä½æ‰€æ¤œç´¢
            if (!cadastralData) {
                addStatus('åœ°ç±ãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            const queryLower = query.toLowerCase();
            const results = cadastralData.features.filter(f => {
                const props = f.properties || {};
                return JSON.stringify(props).toLowerCase().includes(queryLower);
            });
            
            if (results.length === 0) {
                addStatus('æ¤œç´¢çµæœãªã—', 'error');
                return;
            }
            
            const first = results[0];
            if (first.geometry.type === 'Polygon') {
                const coords = first.geometry.coordinates[0];
                const bounds = coords.reduce((acc, c) => {
                    return {
                        minLng: Math.min(acc.minLng, c[0]),
                        maxLng: Math.max(acc.maxLng, c[0]),
                        minLat: Math.min(acc.minLat, c[1]),
                        maxLat: Math.max(acc.maxLat, c[1])
                    };
                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                
                map.fitBounds([[bounds.minLng, bounds.minLat], [bounds.maxLng, bounds.maxLat]], { padding: 40 });
                addStatus(results.length + ' ä»¶ãƒ’ãƒƒãƒˆ', 'success');
            }
        }
        
        // ==========================================
        // åˆæœŸåŒ–
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            // åˆå›ãƒ©ã‚¤ãƒ–ãƒ©ãƒªè¨ºæ–­ï¼ˆæ—©ã‚ã«è¡¨ç¤ºï¼‰
            setTimeout(checkLibraries, 300);
        });
    </script>
</body>
</html>
