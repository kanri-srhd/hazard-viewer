<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÖ®ÂõΩ„Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„Éó„Éì„É•„Éº„Ç¢ (GeoJSON + MapLibre GL)</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üó∫Ô∏è</text></svg>">
    
    <!-- MapLibre GL CSS -->
    <link href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'MS PGothic', sans-serif;
            background: #f0f0f0;
        }
        
        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        .sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            padding: 15px;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        .sidebar h1 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .search-box button {
            width: 100%;
            padding: 8px;
            background: #0b66ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .search-box button:hover {
            background: #0854cc;
        }
        
        .status {
            background: #f9f9f9;
            border-left: 3px solid #0b66ff;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 2px;
            font-size: 11px;
            color: #333;
        }
        
        .status.success {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        
        .status.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        
        .status.loading {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .layer-controls {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 12px;
        }
        
        .layer-controls h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .layer-item input[type="checkbox"] {
            margin-right: 6px;
            cursor: pointer;
        }
        
        .layer-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .info-box {
            background: #f0f8ff;
            border: 1px solid #90caf9;
            border-radius: 4px;
            padding: 8px;
            margin-top: 10px;
            font-size: 11px;
            color: #333;
            line-height: 1.4;
        }
        .detail-panel {
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #222;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="sidebar">
        <h1>üó∫Ô∏è MapLibre GLÁâà „Éè„Ç∂„Éº„Éâ„Éû„ÉÉ„Éó„Éì„É•„Éº„Ç¢</h1>
        
        <div id="statusPanel" style="max-height: 100px; overflow-y: auto;"></div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Âú∞Áï™ / ‰ΩèÊâÄ„ÅßÊ§úÁ¥¢...">
            <button onclick="searchParcel()">üîç Ê§úÁ¥¢</button>
        </div>
        
        <div class="layer-controls">
            <h3>üìç „É¨„Ç§„É§Ë°®Á§∫</h3>
            <div class="layer-item">
                <input type="checkbox" id="toggle-cadastral" checked onchange="toggleLayer('cadastral')">
                <label for="toggle-cadastral">Âú∞Á±ç (ÈªÑËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-flood" checked onchange="toggleLayer('flood')">
                <label for="toggle-flood">Ê¥™Ê∞¥ (ÈùíËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-landslide" checked onchange="toggleLayer('landslide')">
                <label for="toggle-landslide">ÂúüÁ†ÇÁÅΩÂÆ≥ (Ê©ôËâ≤)</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="toggle-tsunami" checked onchange="toggleLayer('tsunami')">
                <label for="toggle-tsunami">Ê¥•Ê≥¢ (Ê∞¥Ëâ≤)</label>
            </div>
        </div>
        
        <div class="info-box">
            <strong>‚ÑπÔ∏è ‰ΩøÁî®ÊñπÊ≥ï</strong><br>
            ‚Ä¢ Ê§úÁ¥¢„ÅßË©≤ÂΩì„Éù„É™„Ç¥„É≥„ÇíÊ§úÁ¥¢<br>
            ‚Ä¢ „ÉÅ„Çß„ÉÉ„ÇØ„Åß„É¨„Ç§„É§Âàá„ÇäÊõø„Åà<br>
            ‚Ä¢ „ÇØ„É™„ÉÉ„ÇØ„ÅßË©≥Á¥∞ÊÉÖÂ†±Ë°®Á§∫
        </div>
        <div id="detailPanel" class="detail-panel">
            <strong>Ë©≥Á¥∞ÊÉÖÂ†±</strong>
            <div id="detailContent" style="margin-top:8px;font-size:13px;color:#333;">Âú∞Âõ≥‰∏ä„ÅÆ„Éï„Ç£„Éº„ÉÅ„É£„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Åì„Åì„Å´Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>
        </div>
    </div>
    
    <!-- MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    
    <script>
        // ==========================================
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        // ==========================================
        let map;
        let cadastralData = null;
        let layerVisibility = { cadastral: true, flood: true, landslide: true, tsunami: true };
        
        function addStatus(msg, type = 'info') {
            const panel = document.getElementById('statusPanel');
            const div = document.createElement('div');
            div.className = 'status ' + type;
            div.textContent = msg;
            panel.insertBefore(div, panel.firstChild);
            if (panel.children.length > 5) {
                panel.removeChild(panel.lastChild);
            }
        }
        
        // ==========================================
        // „Éû„ÉÉ„ÉóÂàùÊúüÂåñ
        // ==========================================
        function initMap() {
            addStatus('„Éû„ÉÉ„ÉóÂàùÊúüÂåñ‰∏≠...', 'loading');
            
            const style = {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap'
                    }
                },
                layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
            };
            
            map = new maplibregl.Map({
                container: 'map',
                style: style,
                center: [135.5, 34.69],
                zoom: 6
            });
            
            map.on('load', () => {
                addStatus('„Éû„ÉÉ„ÉóË™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                loadGeoJSONData();
                
                // Clear detail and popups when clicking outside features
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, { layers: ['cadastral-layer','flood-layer','landslide-layer','tsunami-layer'] });
                    if (!features || features.length === 0) {
                        clearDetail();
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                    }
                });
            });
            
            map.on('error', (err) => {
                console.error('Map error:', err);
                addStatus('„Éû„ÉÉ„Éó„Ç®„É©„Éº', 'error');
            });
        }
        
        // ==========================================
        // GeoJSON „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        // ==========================================
        function loadGeoJSONData() {
            addStatus('Âú∞Á±ç„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠...', 'loading');
            
            fetch('../geojson/27128__6_r_2024.geojson')
                .then(r => r.json())
                .then(geojson => {
                    cadastralData = geojson;
                    
                    map.addSource('cadastral-source', { type: 'geojson', data: geojson });
                    map.addLayer({
                        id: 'cadastral-layer',
                        type: 'fill',
                        source: 'cadastral-source',
                        paint: {
                            'fill-color': '#ffcc00',
                            'fill-opacity': 0.4,
                            'fill-outline-color': '#333'
                        }
                    });
                    // cadastral hover / click handling
                    let cadastralHover = null;
                    map.on('mousemove', 'cadastral-layer', (e) => {
                        map.getCanvas().style.cursor = 'pointer';
                        if (window.__pinnedPopup) return;
                        const props = (e.features && e.features[0] && e.features[0].properties) || {};
                        const brief = formatPropsBrief(props);
                        if (cadastralHover) cadastralHover.remove();
                        cadastralHover = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(brief)
                            .addTo(map);
                    });
                    map.on('mouseleave', 'cadastral-layer', () => {
                        map.getCanvas().style.cursor = '';
                        if (cadastralHover) { cadastralHover.remove(); cadastralHover = null; }
                    });
                    map.on('click', 'cadastral-layer', (e) => {
                        const props = (e.features && e.features[0] && e.features[0].properties) || {};
                        if (window.__pinnedPopup) { try { window.__pinnedPopup.remove(); } catch (err) {} window.__pinnedPopup = null; }
                        window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                            .setLngLat(e.lngLat)
                            .setHTML(formatPropsLong(props))
                            .addTo(map);
                        // zoom to parcel
                        try {
                            const geom = e.features[0].geometry;
                            if (geom && geom.type === 'Polygon') {
                                const coords = geom.coordinates[0];
                                const bounds = coords.reduce((acc, c) => {
                                    return {
                                        minLng: Math.min(acc.minLng, c[0]),
                                        maxLng: Math.max(acc.maxLng, c[0]),
                                        minLat: Math.min(acc.minLat, c[1]),
                                        maxLat: Math.max(acc.maxLat, c[1])
                                    };
                                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                                map.fitBounds([[bounds.minLng, bounds.minLat], [bounds.maxLng, bounds.maxLat]], { padding: 20 });
                            }
                        } catch (err) {}
                        showDetail(props, e.lngLat);
                    });
                    
                    addStatus('Âú∞Á±ç„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü (' + geojson.features.length + ' ‰ª∂)', 'success');
                    loadHazardData();
                })
                .catch(err => {
                    console.error('Cadastral load error:', err);
                    addStatus('Âú∞Á±ç„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂ§±Êïó', 'error');
                });
        }
        
        // ==========================================
        // „Éè„Ç∂„Éº„Éâ „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
        // ==========================================
        function loadHazardData() {
            const hazards = [
                { id: 'flood', url: '../geojson/hazard_sample_flood_osaka.geojson', label: 'Ê¥™Ê∞¥', color: '#0b66ff' },
                { id: 'landslide', url: '../geojson/hazard_sample_landslide_osaka.geojson', label: 'ÂúüÁ†ÇÁÅΩÂÆ≥', color: '#ff8c00' },
                { id: 'tsunami', url: '../geojson/hazard_sample_tsunami_osaka.geojson', label: 'Ê¥•Ê≥¢', color: '#00c8d8' }
            ];
            
            hazards.forEach(h => {
                fetch(h.url)
                    .then(r => r.json())
                    .then(geojson => {
                        map.addSource(h.id + '-source', { type: 'geojson', data: geojson });
                        map.addLayer({
                            id: h.id + '-layer',
                            type: 'fill',
                            source: h.id + '-source',
                            paint: {
                                'fill-color': h.color,
                                'fill-opacity': 0.3,
                                'fill-outline-color': h.color
                            }
                        });
                        
                            // hover popup / click detail handling
                            // hoverPopup: temporary hover popup, pinnedPopup: click-pinned popup
                            let hoverPopup = null;
                            // mousemove: show brief popup
                        map.on('mousemove', h.id + '-layer', (e) => {
                            map.getCanvas().style.cursor = 'pointer';
                            if (window.__pinnedPopup) return;
                            const props = (e.features && e.features[0] && e.features[0].properties) || {};
                            const brief = formatPropsBrief(props);
                            if (hoverPopup) hoverPopup.remove();
                            hoverPopup = new maplibregl.Popup({ closeButton: false, closeOnClick: false })
                                .setLngLat(e.lngLat)
                                .setHTML(brief)
                                .addTo(map);
                        });                            map.on('mouseleave', h.id + '-layer', () => {
                                map.getCanvas().style.cursor = '';
                                if (hoverPopup) {
                                    hoverPopup.remove();
                                    hoverPopup = null;
                                }
                            });

                            // click: pinned popup + detail panel
                            map.on('click', h.id + '-layer', (e) => {
                                const props = (e.features && e.features[0] && e.features[0].properties) || {};
                                // remove any existing pinned popup
                                if (window.__pinnedPopup) {
                                    try { window.__pinnedPopup.remove(); } catch (e) {}
                                    window.__pinnedPopup = null;
                                }
                                window.__pinnedPopup = new maplibregl.Popup({ closeOnClick: false })
                                    .setLngLat(e.lngLat)
                                    .setHTML(formatPropsLong(props))
                                    .addTo(map);
                                showDetail(props, e.lngLat);
                            });
                        addStatus(h.label + ' Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü', 'success');
                    })
                    .catch(err => {
                        console.warn(h.label + ' load error:', err);
                        addStatus(h.label + ' Ë™≠„ÅøËæº„ÅøÂ§±Êïó', 'error');
                    });
            });
        }
        
        // ==========================================
        // Utilities for detail display
        function formatPropsBrief(props) {
            if (!props) return '<div>ÊÉÖÂ†±„Å™„Åó</div>';
            const name = props.name || props.chiban || props.address || props.block || '';
            return `<div style="font-size:12px;"><strong>${name}</strong></div>`;
        }

        function formatPropsLong(props) {
            if (!props) return '<div>ÊÉÖÂ†±„Å™„Åó</div>';
            let html = '<div style="font-size:13px;line-height:1.4;">';
            const keys = Object.keys(props);
            keys.forEach(k => {
                const v = props[k];
                if (v === null || v === undefined || v === '') return;
                html += `<div><strong>${k}</strong>: ${String(v)}</div>`;
            });
            html += '</div>';
            return html;
        }

        function showDetail(props, lngLat) {
            const el = document.getElementById('detailContent');
            if (!el) return;
            let html = '<div style="font-size:13px;">';
            if (props.name) html += `<div style="font-weight:600;margin-bottom:6px">${props.name}</div>`;
            if (props.hazard_type) html += `<div><strong>„Çø„Ç§„Éó:</strong> ${props.hazard_type}</div>`;
            if (props.severity) html += `<div><strong>ÈáçË¶ÅÂ∫¶:</strong> ${props.severity}</div>`;
            if (props.depth_cm) html += `<div><strong>Êµ∏Ê∞¥Ê∑±(cm):</strong> ${props.depth_cm}</div>`;
            if (props.depth_m) html += `<div><strong>Êµ∏Ê∞¥Ê∑±(m):</strong> ${props.depth_m}</div>`;
            if (props.address) html += `<div><strong>‰ΩèÊâÄ:</strong> ${props.address}</div>`;
            if (props.chiban) html += `<div><strong>Âú∞Áï™:</strong> ${props.chiban}</div>`;
            // google maps link (try to compute centroid if lngLat not provided)
            let lat = null, lng = null;
            if (lngLat && lngLat.lng !== undefined) { lat = lngLat.lat; lng = lngLat.lng; }
            else if (props.latitude && props.longitude) { lat = props.latitude; lng = props.longitude; }
            if (!lat && props.geometry) {
                try {
                    const geom = props.geometry;
                    // if geometry contains coordinates
                } catch (e) {}
            }
            if (lat && lng) {
                html += `<div style="margin-top:6px"><a target="_blank" href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}">Google „Éû„ÉÉ„Éó„ÅßÈñã„Åè</a></div>`;
            }
            html += '<div style="margin-top:8px"><button id="detailCloseBtn" class="btn">Èñâ„Åò„Çã</button></div>';
            html += '</div>';
            el.innerHTML = html;
            const btn = document.getElementById('detailCloseBtn');
            if (btn) btn.addEventListener('click', clearDetail);
        }

        function clearDetail() {
            const el = document.getElementById('detailContent');
            if (!el) return;
            el.innerHTML = 'Âú∞Âõ≥‰∏ä„ÅÆ„Éï„Ç£„Éº„ÉÅ„É£„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Åì„Åì„Å´Ë©≥Á¥∞„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ';
        }
        function toggleLayer(name) {
            const checkbox = document.getElementById('toggle-' + name);
            const visibility = checkbox.checked ? 'visible' : 'none';
            
            if (map.getLayer(name + '-layer')) {
                map.setLayoutProperty(name + '-layer', 'visibility', visibility);
            }
        }
        
        // ==========================================
        // Ê§úÁ¥¢Ê©üËÉΩ
        // ==========================================
        function searchParcel() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            if (!query || !cadastralData) {
                addStatus('Ê§úÁ¥¢Ë™û„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
                return;
            }
            
            const results = cadastralData.features.filter(f => {
                const props = f.properties || {};
                return JSON.stringify(props).toLowerCase().includes(query);
            });
            
            if (results.length === 0) {
                addStatus('Ê§úÁ¥¢ÁµêÊûú„Å™„Åó', 'error');
                return;
            }
            
            const first = results[0];
            if (first.geometry.type === 'Polygon') {
                const coords = first.geometry.coordinates[0];
                const bounds = coords.reduce((acc, c) => {
                    return {
                        minLng: Math.min(acc.minLng, c[0]),
                        maxLng: Math.max(acc.maxLng, c[0]),
                        minLat: Math.min(acc.minLat, c[1]),
                        maxLat: Math.max(acc.maxLat, c[1])
                    };
                }, { minLng: Infinity, maxLng: -Infinity, minLat: Infinity, maxLat: -Infinity });
                
                map.fitBounds([[bounds.minLng, bounds.minLat], [bounds.maxLng, bounds.maxLat]], { padding: 40 });
                addStatus(results.length + ' ‰ª∂„Éí„ÉÉ„Éà', 'success');
            }
        }
        
        // ==========================================
        // ÂàùÊúüÂåñ
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
        });
    </script>
</body>
</html>
